<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard B·ªë M·∫π üìä</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>


    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .tab-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-card .icon {
            font-size: 2em;
            float: right;
            opacity: 0.5;
        }

        .alert-card {
            background: #ff5252;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-card .icon {
            font-size: 2.5em;
        }

        .alert-card.warning {
            background: #ff9800;
        }

        .alert-card.info {
            background: #2196f3;
        }

        .session-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .session-item {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .session-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .session-item.exam-mode {
            border-left-color: #ff9800;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .session-mode {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .session-mode.exam {
            background: #ff9800;
        }

        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .detail-item {
            font-size: 0.9em;
            color: #666;
        }

        .detail-item strong {
            color: #333;
        }

        .reward-badge {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 300px;
            padding: 20px;
            border-bottom: 2px solid #ddd;
        }

        .bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 60px;
            border-radius: 10px 10px 0 0;
            position: relative;
            transition: all 0.3s;
        }

        .bar:hover {
            opacity: 0.8;
            transform: scaleY(1.05);
        }

        .bar-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #667eea;
        }

        .schedule-editor {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .schedule-day {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .schedule-day h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-small {
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-success {
            background: #4caf50;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.3s;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
.input-group {
    margin: 15px 0;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}

.input-group input,
.input-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1em;
    background: #f9f9f9;
}

.input-group input:focus,
.input-group select:focus {
    border-color: #667eea;
    outline: none;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Dashboard B·ªë M·∫π</h1>
                <p style="color: #666; margin-top: 5px;" id="currentDate"></p>
            </div>
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">T·ªïng quan</button>
                <button class="tab-btn" onclick="switchTab('sessions')">L·ªãch s·ª≠</button>
                <button class="tab-btn" onclick="switchTab('stats')">Th·ªëng k√™</button>
                <button class="tab-btn" onclick="switchTab('schedule')">Th·ªùi kh√≥a bi·ªÉu</button>
                <button class="tab-btn" onclick="switchTab('rewards')">Ti·ªÅn th∆∞·ªüng</button>
<button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è C√†i ƒë·∫∑t</button>
<button class="tab-btn" onclick="switchTab('messages')">üí¨ Tin nh·∫Øn v·ªõi con</button>
            </div>
        </div>

        <!-- TAB 1: T·ªîNG QUAN -->
        <div id="tab-overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üìö</div>
                    <div class="label">M√¥n ƒë√£ ho√†n th√†nh h√¥m nay</div>
                    <div class="value" id="todayCompleted">0/0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚è±Ô∏è</div>
                    <div class="label">T·ªïng th·ªùi gian h·ªçc h√¥m nay</div>
                    <div class="value" id="todayTime">0h 0m</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üí∞</div>
                    <div class="label">Ti·ªÅn th∆∞·ªüng h√¥m nay</div>
                    <div class="value" id="todayReward">0ƒë</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üéØ</div>
                    <div class="label">T·ª∑ l·ªá ho√†n th√†nh</div>
                    <div class="value" id="todayCompletion">0%</div>
                </div>
            </div>

            <div class="card">
                <h2>‚ö†Ô∏è C·∫£nh b√°o & Th√¥ng b√°o</h2>
                <div id="alertsContainer"></div>
            </div>

            <div class="card">
                <h2>üìù Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h2>
                <div id="recentActivities"></div>
            </div>
        </div>

        <!-- TAB 2: L·ªäCH S·ª¨ -->
        <div id="tab-sessions" class="tab-content">
            <div class="card">
                <h2>üìñ L·ªãch s·ª≠ l√†m b√†i</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterSessions('all')">T·∫•t c·∫£</button>
                    <button class="filter-btn" onclick="filterSessions('today')">H√¥m nay</button>
                    <button class="filter-btn" onclick="filterSessions('week')">Tu·∫ßn n√†y</button>
                    <button class="filter-btn" onclick="filterSessions('month')">Th√°ng n√†y</button>
                </div>
                <div class="session-list" id="sessionsList"></div>
            </div>
        </div>

        <!-- TAB 3: TH·ªêNG K√ä -->
        <div id="tab-stats" class="tab-content">
            <div class="card">
                <h2>üìä Th·ªùi gian h·ªçc theo ng√†y (7 ng√†y g·∫ßn nh·∫•t)</h2>
                <div class="bar-chart" id="timeChart"></div>
            </div>

            <div class="card">
                <h2>üìà Xu h∆∞·ªõng ti·∫øn b·ªô</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="label">Th·ªùi gian h·ªçc trung b√¨nh/ng√†y</div>
                        <div class="value" id="avgTimePerDay">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">T·ª∑ l·ªá ho√†n th√†nh trung b√¨nh</div>
                        <div class="value" id="avgCompletion">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">S·ªë l·∫ßn g·ªçi b·ªë m·∫π (tu·∫ßn)</div>
                        <div class="value" id="callParentCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">S·ªë l·∫ßn d√πng Chat AI (tu·∫ßn)</div>
                        <div class="value" id="chatAICount">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üéØ Ph√¢n t√≠ch chi ti·∫øt</h2>
                <div id="detailedAnalysis"></div>
            </div>
        </div>

        <!-- TAB 4: TH·ªúI KH√ìA BI·ªÇU -->
        <div id="tab-schedule" class="tab-content">
            <div class="card">
                <h2>üìÖ Qu·∫£n l√Ω Th·ªùi kh√≥a bi·ªÉu</h2>
                <p style="color: #666; margin-bottom: 20px;">Xem v√† ch·ªânh s·ª≠a l·ªãch h·ªçc c·ªßa con</p>
                <div id="scheduleEditor"></div>
            </div>
        </div>

        <!-- TAB 5: TI·ªÄN TH∆Ø·ªûNG -->
        <div id="tab-rewards" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üí∞</div>
                    <div class="label">T·ªïng ti·ªÅn ch∆∞a tr·∫£</div>
                    <div class="value" id="unpaidReward">0ƒë</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚úÖ</div>
                    <div class="label">ƒê√£ tr·∫£ tu·∫ßn n√†y</div>
                    <div class="value" id="paidThisWeek">0ƒë</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üìä</div>
                    <div class="label">T·ªïng t√≠ch l≈©y th√°ng n√†y</div>
                    <div class="value" id="totalThisMonth">0ƒë</div>
                </div>
            </div>

              <div class="card">
                <h2>üéÅ Th∆∞·ªüng n√≥ng cho con</h2>
                <p style="color: #666; margin-bottom: 20px;">Th∆∞·ªüng th√™m cho con khi l√†m t·ªët ho·∫∑c v∆∞·ª£t ch·ªâ ti√™u</p>
                <div style="background: #f8f9ff; padding: 25px; border-radius: 15px;">
                    <div class="input-group">
                        <label>S·ªë ti·ªÅn th∆∞·ªüng:</label>
                        <input type="number" id="hotRewardAmount" placeholder="V√≠ d·ª•: 5000" style="font-size: 1.2em; padding: 15px;">
                    </div>
                    <div class="input-group">
                        <label>L√Ω do th∆∞·ªüng:</label>
                        <textarea id="hotRewardReason" placeholder="V√≠ d·ª•: L√†m th√™m 10 b√†i to√°n n√¢ng cao, h·ªçc ch·ªß ƒë·ªông..." style="height: 80px; font-size: 1.1em; padding: 15px;"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="giveHotReward()" style="width: 100%; padding: 18px; font-size: 1.3em; background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);">
                        üéÅ T·∫∑ng th∆∞·ªüng ngay
                    </button>
                </div>
            </div>

            <div class="card">
                <h2>üí∏ L·ªãch s·ª≠ ti·ªÅn th∆∞·ªüng</h2>
                <div id="rewardHistory"></div>
            </div>
        </div>
    </div>
<!-- TAB 6: C√ÄI ƒê·∫∂T TH∆Ø·ªûNG -->
<div id="tab-settings" class="tab-content">
    <div class="card">
        <h2>‚öôÔ∏è C√†i ƒë·∫∑t ti·ªÅn th∆∞·ªüng</h2>
        <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
            <div class="input-group">
                <label>L√†m ƒë√∫ng th·ªùi gian:</label>
                <input type="number" id="rewardOnTime" value="2000"> ƒë·ªìng
            </div>
            <div class="input-group">
                <label>L√†m nhanh h∆°n 20%:</label>
                <input type="number" id="rewardFast" value="1000"> ƒë·ªìng
            </div>
            <div class="input-group">
                <label>Ho√†n th√†nh 100%:</label>
                <input type="number" id="reward100" value="2000"> ƒë·ªìng
            </div>
            <div class="input-group">
                <label>Ho√†n th√†nh 90%+:</label>
                <input type="number" id="reward90" value="1000"> ƒë·ªìng
            </div>
            <div class="input-group">
                <label>Ch·∫ø ƒë·ªô luy·ªán thi (bonus):</label>
                <input type="number" id="rewardExam" value="1000"> ƒë·ªìng
            </div>
            <button class="btn btn-success" onclick="saveRewardSettings()">üíæ L∆∞u c√†i ƒë·∫∑t</button>
        </div>
    </div>
<div class="card">
    <h2>‚öôÔ∏è C√†i ƒë·∫∑t ho·∫°t ƒë·ªông ra ch∆°i</h2>
    <p style="color: #666; margin-bottom: 20px;">Th√™m/s·ª≠a/x√≥a g·ª£i √Ω ho·∫°t ƒë·ªông cho con trong gi·ªù ngh·ªâ</p>
    <div id="activitiesList" style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;"></div>
    <button class="btn btn-success" onclick="addActivity()">+ Th√™m ho·∫°t ƒë·ªông m·ªõi</button>
</div>

<!-- Modal ch·ªânh s·ª≠a/th√™m ho·∫°t ƒë·ªông -->
<div class="modal" id="activityModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeActivityModal()">&times;</button>
        <h2 id="activityModalTitle" style="color: #667eea; margin-bottom: 20px;">Th√™m Ho·∫°t ƒë·ªông</h2>
        <form id="activityForm">
            <div class="input-group">
                <label>T√™n ho·∫°t ƒë·ªông (v√≠ d·ª•: Nh·∫£y theo nh·∫°c):</label>
                <input type="text" id="activityName" required>
            </div>
            <div class="input-group">
                <label>Icon (emoji, v√≠ d·ª•: üíÉ):</label>
                <input type="text" id="activityIcon" required>
            </div>
            <input type="hidden" id="activityIndex"> <!-- ·∫®n: l∆∞u index n·∫øu edit -->
            <button type="submit" class="btn btn-success" style="width: 100%;">üíæ L∆∞u</button>
        </form>
    </div>
</div>
</div>
<div id="tab-messages" class="tab-content">
    <div class="card">
        <h2>üí¨ Tin nh·∫Øn v·ªõi con</h2>
        <div id="parentMessagesList" style="max-height: 500px; overflow-y: auto; margin-bottom: 20px;"></div>
        <div style="background: #f0f4ff; padding: 15px; border-radius: 10px;">
            <textarea id="parentMessageInput" placeholder="Nh·∫Øn g√¨ cho con..." style="width: 100%; height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #667eea;"></textarea>
            <button class="btn btn-success" onclick="sendParentMessage()" style="margin-top: 10px; width: 100%;">G·ª≠i tin nh·∫Øn</button>
        </div>
    </div>
</div>

    <!-- Modal chi ti·∫øt session -->
    <div class="modal" id="sessionModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <div id="sessionDetail"></div>
        </div>
    </div>

    <script>
        // Load data
        let sessionHistory = [];
        let activityLogs = [];
        let completedSubjects = [];
        let currentFilter = 'all';

let SCHEDULE = {};

async function loadScheduleFromFirebase() {
    try {
        const doc = await db.collection('settings').doc('schedule').get();
        if (doc.exists && doc.data().schedule) {
            SCHEDULE = doc.data().schedule;
            console.log('‚úÖ ƒê√£ load schedule t·ª´ Firebase');
        } else {
            SCHEDULE = {};
        }
    } catch (error) {
        console.error('‚ùå Load schedule error:', error);
        SCHEDULE = {};
    }
}

let ACTIVITIES = [];


const firebaseConfig = {
  apiKey: "AIzaSyBv5qOVgNajnOKoz-vaIYENSWZY2jB8N30",
  authDomain: "honey-4d9b1.firebaseapp.com",
  projectId: "honey-4d9b1",
  storageBucket: "honey-4d9b1.firebasestorage.app",
  messagingSenderId: "108470975596",
  appId: "1:108470975596:web:c3223c55e7afbd9276ac49"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

        window.onload = async function() {
await loadScheduleFromFirebase();   
 await loadActivities();
 await loadData(); // ƒê·ª£i load xong
    displayCurrentDate();
    updateOverview();
    displayRecentActivities();
    displayAlerts();
    renderSessions();
    renderStats();
    renderSchedule();
    renderRewards();
};

        async function loadData() {
    try {
        // ƒê·ªçc sessionHistory t·ª´ Firebase
        const sessionsSnapshot = await db.collection('sessions').orderBy('date', 'desc').get();
        sessionHistory = sessionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // ƒê·ªçc activityLogs
        const logsSnapshot = await db.collection('activityLogs').orderBy('timestamp', 'desc').limit(100).get();
        activityLogs = logsSnapshot.docs.map(doc => doc.data());
        
        // ƒê·ªçc completedSubjects (h√¥m nay)
        const today = new Date().toDateString();
        const progressDoc = await db.collection('dailyProgress').doc(today).get();
        completedSubjects = progressDoc.exists ? progressDoc.data().completed || [] : [];
        
    } catch (error) {
        console.error('Load data error:', error);
        // Fallback v·ªÅ localStorage n·∫øu l·ªói
        sessionHistory = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
        activityLogs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
        completedSubjects = JSON.parse(localStorage.getItem('completedSubjects') || '[]');
    }
}


        function displayCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('vi-VN', options);
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        function updateOverview() {
            const today = new Date().toDateString();
            const todaySessions = sessionHistory.filter(s => new Date(s.date).toDateString() === today);
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = days[new Date().getDay()];
            const todaySchedule = SCHEDULE[dayName] || [];
            const homeworkCount = todaySchedule.filter(s => s.type === 'homework').length;

            // Completed subjects today
            document.getElementById('todayCompleted').textContent = `${completedSubjects.length}/${homeworkCount}`;

            // Total time today
            const totalSeconds = todaySessions.reduce((sum, s) => sum + (s.time || 0), 0);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            document.getElementById('todayTime').textContent = `${hours}h ${minutes}m`;

            // Total reward today
            const totalReward = todaySessions.reduce((sum, s) => sum + (s.reward || 0), 0);
            document.getElementById('todayReward').textContent = `${totalReward.toLocaleString('vi-VN')}ƒë`;

            // Completion rate
            const completionRate = homeworkCount > 0 ? ((completedSubjects.length / homeworkCount) * 100).toFixed(0) : 0;
            document.getElementById('todayCompletion').textContent = `${completionRate}%`;
        }

        function displayAlerts() {
            const container = document.getElementById('alertsContainer');
            const recentLogs = activityLogs.slice(-10).reverse();
            
            const alerts = recentLogs.filter(log => 
                log.type.includes('C·∫¢NH B√ÅO') || 
                log.type.includes('C·∫£nh b√°o') ||
                log.type.includes('G·ªçi')
            );

            if (alerts.length === 0) {
                container.innerHTML = '<p style="color: #4caf50;">‚úÖ Kh√¥ng c√≥ c·∫£nh b√°o. M·ªçi th·ª© ƒë·ªÅu ·ªïn!</p>';
                return;
            }

            container.innerHTML = alerts.map(alert => {
                const time = new Date(alert.timestamp).toLocaleTimeString('vi-VN');
                const isWarning = alert.type.includes('C·∫¢NH B√ÅO');
                const isCall = alert.type.includes('G·ªçi');
                
                return `
                    <div class="alert-card ${isWarning ? '' : isCall ? 'info' : 'warning'}">
                        <div class="icon">${isWarning ? '‚ö†Ô∏è' : isCall ? 'üìû' : '‚ÑπÔ∏è'}</div>
                        <div>
                            <strong>${alert.type}</strong><br>
                            ${alert.detail}<br>
                            <small>${time}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayRecentActivities() {
            const container = document.getElementById('recentActivities');
            const recent = activityLogs.slice(-5).reverse();

            if (recent.length === 0) {
                container.innerHTML = '<p style="color: #999;">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>';
                return;
            }

            container.innerHTML = recent.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString('vi-VN');
                const date = new Date(log.timestamp).toLocaleDateString('vi-VN');
                return `
                    <div style="padding: 15px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;">
                        <strong>${log.type}</strong>: ${log.detail}<br>
                        <small style="color: #999;">${date} ${time}</small>
                    </div>
                `;
            }).join('');
        }

        function renderSessions() {
            const container = document.getElementById('sessionsList');
            let filtered = sessionHistory;

            if (currentFilter === 'today') {
                const today = new Date().toDateString();
                filtered = sessionHistory.filter(s => new Date(s.date).toDateString() === today);
            } else if (currentFilter === 'week') {
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                filtered = sessionHistory.filter(s => new Date(s.date) >= weekAgo);
            } else if (currentFilter === 'month') {
                const monthAgo = new Date();
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                filtered = sessionHistory.filter(s => new Date(s.date) >= monthAgo);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>';
                return;
            }

            container.innerHTML = filtered.reverse().map(session => {
                const date = new Date(session.date).toLocaleDateString('vi-VN');
                const time = new Date(session.date).toLocaleTimeString('vi-VN');
                const duration = formatDuration(session.time || 0);
                const isExam = session.mode === 'exam';
                
                return `
                    <div class="session-item ${isExam ? 'exam-mode' : ''}" onclick="showSessionDetail('${session.id}')">
                        <div class="session-header">
                            <div class="session-title">${session.subject}</div>
                            <div class="session-mode ${isExam ? 'exam' : ''}">${isExam ? 'Thi' : 'Luy·ªán t·∫≠p'}</div>
                        </div>
                        <div class="session-details">
                            <div class="detail-item">
                                <strong>üìÖ Ng√†y:</strong> ${date}
                            </div>
                            <div class="detail-item">
                                <strong>‚è∞ Gi·ªù:</strong> ${time}
                            </div>
                            <div class="detail-item">
                                <strong>‚è±Ô∏è Th·ªùi gian:</strong> ${duration}
                            </div>
                            <div class="detail-item">
                                <strong>üí∞ Th∆∞·ªüng:</strong> ${(session.reward || 0).toLocaleString('vi-VN')}ƒë
                            </div>
                            ${session.score !== undefined ? `
                            <div class="detail-item">
                                <strong>üìä ƒêi·ªÉm:</strong> ${session.score}/${session.total}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterSessions(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderSessions();
        }

        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function showSessionDetail(sessionId) {
            const session = sessionHistory.find(s => s.id === sessionId);
            if (!session) return;

            const modal = document.getElementById('sessionModal');
            const detailContainer = document.getElementById('sessionDetail');

            const date = new Date(session.date).toLocaleDateString('vi-VN');
            const time = new Date(session.date).toLocaleTimeString('vi-VN');
            const duration = formatDuration(session.time || 0);

            detailContainer.innerHTML = `
                <h2 style="color: #667eea; margin-bottom: 20px;">${session.subject}</h2>
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">üìã Th√¥ng tin chung</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>Ng√†y gi·ªù:</strong> ${date} ${time}</div>
                        <div><strong>Th·ªùi gian l√†m:</strong> ${duration}</div>
                        <div><strong>M·ª•c ti√™u:</strong> ${session.targetTime ? formatDuration(session.targetTime) : 'Kh√¥ng c√≥'}</div>
                        <div><strong>Ti·ªÅn th∆∞·ªüng:</strong> ${(session.reward || 0).toLocaleString('vi-VN')}ƒë</div>
                    </div>
                </div>

                ${session.questions && session.questions.length > 0 ? `
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">üìù Chi ti·∫øt t·ª´ng c√¢u</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${session.questions.map((q, idx) => `
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${q.completed ? '#4caf50' : '#ff9800'};">
                                <strong>C√¢u ${idx + 1}:</strong> ${q.completed ? '‚úÖ ƒê√£ ho√†n th√†nh' : '‚è≥ Ch∆∞a ho√†n th√†nh'}
                                ${q.timeSpent ? `<br><small>Th·ªùi gian: ${formatDuration(q.timeSpent)}</small>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${session.aiChatCount || session.callParentCount ? `
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">üîß C√¥ng c·ª• h·ªó tr·ª£</h3>
                    ${session.aiChatCount ? `<p>üí¨ S·ªë l·∫ßn d√πng Chat AI: <strong>${session.aiChatCount}</strong></p>` : ''}
                    ${session.callParentCount ? `<p>üìû S·ªë l·∫ßn g·ªçi b·ªë m·∫π: <strong>${session.callParentCount}</strong></p>` : ''}
                </div>
                ` : ''}

                ${session.feedback ? `
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">üí° Nh·∫≠n x√©t & ƒê·ªông vi√™n</h3>
                    <p>${session.feedback}</p>
                </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('sessionModal').classList.remove('active');
        }

        function renderStats() {
            renderTimeChart();
            calculateAverages();
            renderDetailedAnalysis();
        }

        function renderTimeChart() {
            const container = document.getElementById('timeChart');
            const last7Days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push({
                    date: date.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'}),
                    dateStr: date.toDateString()
                });
            }

            const dailyTime = last7Days.map(day => {
                const sessions = sessionHistory.filter(s => new Date(s.date).toDateString() === day.dateStr);
                const totalSeconds = sessions.reduce((sum, s) => sum + (s.time || 0), 0);
                return {
                    label: day.date,
                    value: Math.round(totalSeconds / 3600 * 10) / 10, // hours
                    height: totalSeconds > 0 ? Math.max((totalSeconds / 3600) * 30, 20) : 0
                };
            });

            const maxHeight = Math.max(...dailyTime.map(d => d.height), 100);

            container.innerHTML = dailyTime.map(day => `
                <div style="text-align: center;">
                    <div class="bar" style="height: ${(day.height / maxHeight) * 100}%">
                        <div class="bar-value">${day.value}h</div>
                    </div>
                    <div class="bar-label">${day.label}</div>
                </div>
            `).join('');
        }

        function calculateAverages() {
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekSessions = sessionHistory.filter(s => new Date(s.date) >= weekAgo);

            // Average time per day
            const totalSeconds = weekSessions.reduce((sum, s) => sum + (s.time || 0), 0);
            const avgSecondsPerDay = totalSeconds / 7;
            const avgHours = Math.round(avgSecondsPerDay / 3600 * 10) / 10;
            document.getElementById('avgTimePerDay').textContent = `${avgHours}h`;

            // Average completion rate
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            let totalCompletion = 0;
            let daysCount = 0;

            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayName = days[date.getDay()];
                const schedule = SCHEDULE[dayName] || [];
                const homeworkCount = schedule.filter(s => s.type === 'homework').length;
                
                if (homeworkCount > 0) {
                    const daySessions = sessionHistory.filter(s => 
                        new Date(s.date).toDateString() === date.toDateString()
                    );
                    const completed = daySessions.length;
                    totalCompletion += (completed / homeworkCount) * 100;
                    daysCount++;
                }
            }

            const avgCompletion = daysCount > 0 ? Math.round(totalCompletion / daysCount) : 0;
            document.getElementById('avgCompletion').textContent = `${avgCompletion}%`;

            // Call parent count
            const callCount = weekSessions.reduce((sum, s) => sum + (s.callParentCount || 0), 0);
            document.getElementById('callParentCount').textContent = callCount;

            // Chat AI count
            const chatCount = weekSessions.reduce((sum, s) => sum + (s.aiChatCount || 0), 0);
            document.getElementById('chatAICount').textContent = chatCount;
        }

        function renderDetailedAnalysis() {
            const container = document.getElementById('detailedAnalysis');
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekSessions = sessionHistory.filter(s => new Date(s.date) >= weekAgo);

            // Analyze by subject
            const subjectStats = {};
            weekSessions.forEach(session => {
                if (!subjectStats[session.subject]) {
                    subjectStats[session.subject] = {
                        count: 0,
                        totalTime: 0,
                        totalReward: 0,
                        avgScore: 0,
                        totalScore: 0,
                        scoreCount: 0
                    };
                }
                subjectStats[session.subject].count++;
                subjectStats[session.subject].totalTime += session.time || 0;
                subjectStats[session.subject].totalReward += session.reward || 0;
                if (session.score !== undefined) {
                    subjectStats[session.subject].totalScore += (session.score / session.total) * 100;
                    subjectStats[session.subject].scoreCount++;
                }
            });

            // Calculate averages
            Object.keys(subjectStats).forEach(subject => {
                const stats = subjectStats[subject];
                if (stats.scoreCount > 0) {
                    stats.avgScore = Math.round(stats.totalScore / stats.scoreCount);
                }
            });

            container.innerHTML = `
                <div style="display: grid; gap: 20px;">
                    ${Object.keys(subjectStats).map(subject => {
                        const stats = subjectStats[subject];
                        const avgTime = formatDuration(Math.round(stats.totalTime / stats.count));
                        return `
                            <div style="background: #f5f5f5; padding: 20px; border-radius: 10px;">
                                <h3 style="color: #667eea; margin-bottom: 15px;">${subject}</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                    <div>
                                        <div style="color: #666; font-size: 0.9em;">S·ªë bu·ªïi h·ªçc</div>
                                        <div style="font-size: 1.5em; font-weight: bold; color: #333;">${stats.count}</div>
                                    </div>
                                    <div>
                                        <div style="color: #666; font-size: 0.9em;">Th·ªùi gian TB</div>
                                        <div style="font-size: 1.5em; font-weight: bold; color: #333;">${avgTime}</div>
                                    </div>
                                    <div>
                                        <div style="color: #666; font-size: 0.9em;">T·ªïng th∆∞·ªüng</div>
                                        <div style="font-size: 1.5em; font-weight: bold; color: #333;">${stats.totalReward.toLocaleString('vi-VN')}ƒë</div>
                                    </div>
                                    ${stats.scoreCount > 0 ? `
                                    <div>
                                        <div style="color: #666; font-size: 0.9em;">ƒêi·ªÉm TB</div>
                                        <div style="font-size: 1.5em; font-weight: bold; color: #333;">${stats.avgScore}%</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleEditor');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayNames = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß nh·∫≠t'];

            container.innerHTML = days.map((day, idx) => {
                const schedule = SCHEDULE[day] || [];
                return `
                    <div class="schedule-day">
                        <h3>${dayNames[idx]}</h3>
                        ${schedule.map((item, itemIdx) => {
                            const typeLabel = item.type === 'homework' ? 'üìù B√†i t·∫≠p' : 
                                            item.type === 'class' ? 'üè´ L·ªõp h·ªçc' : '‚òï Ngh·ªâ ng∆°i';
                            return `
                                <div class="schedule-item">
                                    <div>
                                        <strong>${item.time}</strong><br>
                                        ${typeLabel}: ${item.subject}
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-small" onclick="editScheduleItem('${day}', ${itemIdx})">S·ª≠a</button>
                                        <button class="btn btn-small btn-danger" onclick="deleteScheduleItem('${day}', ${itemIdx})">X√≥a</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        <button class="btn btn-success" onclick="addScheduleItem('${day}')" style="margin-top: 10px;">+ Th√™m m√¥n h·ªçc</button>
                    </div>
                `;
            }).join('');
        }

        function editScheduleItem(day, index) {
    const modal = document.getElementById('scheduleModal');
    const title = document.getElementById('modalTitle');
    const form = document.getElementById('scheduleForm');
    
    const item = SCHEDULE[day][index];
    
    title.textContent = 'Ch·ªânh s·ª≠a M√¥n h·ªçc';
    document.getElementById('editTime').value = item.time;
    document.getElementById('editSubject').value = item.subject;
    document.getElementById('editType').value = item.type;
    document.getElementById('editDay').value = day;
    document.getElementById('editIndex').value = index;
    
    modal.classList.add('active');
    
    // X·ª≠ l√Ω submit form
    form.onsubmit = function(e) {
        e.preventDefault();
        const newTime = document.getElementById('editTime').value;
        const newSubject = document.getElementById('editSubject').value;
        const newType = document.getElementById('editType').value;
        
        if (!newTime || !newSubject || !newType) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
            return;
        }
        
        SCHEDULE[day][index] = {
            time: newTime,
            subject: newSubject,
            type: newType
        };
        
        saveScheduleToFirebase(); // L∆∞u l√™n Firebase
        renderSchedule(); // Reload l·ªãch
        closeScheduleModal();
        alert('ƒê√£ c·∫≠p nh·∫≠t!');
    };
}

async function saveScheduleToFirebase() {
    try {
        await db.collection('settings').doc('schedule').set({ schedule: SCHEDULE });
    } catch (error) {
        console.error('Save schedule error:', error);
    }
}

        function deleteScheduleItem(day, index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n h·ªçc n√†y?')) {
                SCHEDULE[day].splice(index, 1);
                renderSchedule();
                alert('ƒê√£ x√≥a!');
            }
        }

       function addScheduleItem(day) {
    const modal = document.getElementById('scheduleModal');
    const title = document.getElementById('modalTitle');
    const form = document.getElementById('scheduleForm');
    
    title.textContent = 'Th√™m M√¥n h·ªçc m·ªõi';
    document.getElementById('editTime').value = '';
    document.getElementById('editSubject').value = '';
    document.getElementById('editType').value = 'homework';
    document.getElementById('editDay').value = day;
    document.getElementById('editIndex').value = ''; // Kh√¥ng c√≥ index v√¨ l√† add m·ªõi
    
    modal.classList.add('active');
    
    // X·ª≠ l√Ω submit form
    form.onsubmit = function(e) {
        e.preventDefault();
        const newTime = document.getElementById('editTime').value;
        const newSubject = document.getElementById('editSubject').value;
        const newType = document.getElementById('editType').value;
        
        if (!newTime || !newSubject || !newType) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
            return;
        }
        
        SCHEDULE[day].push({
            time: newTime,
            subject: newSubject,
            type: newType
        });
        
        saveScheduleToFirebase(); // L∆∞u l√™n Firebase
        renderSchedule(); // Reload l·ªãch
        closeScheduleModal();
        alert('ƒê√£ th√™m!');
    };
}

       function renderRewards() {
    // Calculate rewards
    const today = new Date();
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay());
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

    const unpaid = sessionHistory.filter(s => !s.paid).reduce((sum, s) => sum + (s.reward || 0), 0);
    const paidThisWeek = sessionHistory.filter(s => s.paid && new Date(s.paidDate) >= weekStart)
        .reduce((sum, s) => sum + (s.reward || 0), 0);
    const totalThisMonth = sessionHistory.filter(s => new Date(s.date) >= monthStart)
        .reduce((sum, s) => sum + (s.reward || 0), 0);

    document.getElementById('unpaidReward').textContent = `${unpaid.toLocaleString('vi-VN')}ƒë`;
    document.getElementById('paidThisWeek').textContent = `${paidThisWeek.toLocaleString('vi-VN')}ƒë`;
    document.getElementById('totalThisMonth').textContent = `${totalThisMonth.toLocaleString('vi-VN')}ƒë`;

    // Render history
    const container = document.getElementById('rewardHistory');
    const rewardSessions = sessionHistory.filter(s => s.reward && s.reward > 0).reverse();

    if (rewardSessions.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">Ch∆∞a c√≥ l·ªãch s·ª≠ th∆∞·ªüng.</p>';
        return;
    }

    container.innerHTML = rewardSessions.map(session => {
        const date = new Date(session.date).toLocaleDateString('vi-VN');
        const time = new Date(session.date).toLocaleTimeString('vi-VN');
        return `
            <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <strong>${session.subject}</strong><br>
                        <small style="color: #666;">${date} ${time}</small>
                        ${session.feedback ? `<br><small style="color: #888; font-style: italic;">"${session.feedback.substring(0, 100)}..."</small>` : ''}
                    </div>
                    <div class="reward-badge">${session.reward.toLocaleString('vi-VN')}ƒë</div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                    ${session.paid ? 
                        '<div style="color: #4caf50; font-size: 0.9em;">‚úÖ ƒê√£ tr·∫£</div>' : 
                        '<button class="btn btn-small btn-success" onclick="markAsPaid(\''+session.id+'\')">ƒê√°nh d·∫•u ƒë√£ tr·∫£</button>'
                    }
                    <button class="btn btn-small" onclick="editReward('${session.id}')" style="background: #ff9800;">‚úèÔ∏è S·ª≠a ti·ªÅn</button>
                    <button class="btn btn-small btn-danger" onclick="deleteReward('${session.id}')">üóëÔ∏è X√≥a</button>
                </div>
            </div>
        `;
    }).join('');
}

        async function markAsPaid(sessionId) {
    try {
        await db.collection('sessions').doc(sessionId).update({
            paid: true,
            paidDate: new Date().toISOString()
        });
        
        // C·∫≠p nh·∫≠t local state
        const session = sessionHistory.find(s => s.id === sessionId);
        if (session) {
            session.paid = true;
            session.paidDate = new Date().toISOString();
        }
        
        renderRewards();
        alert('ƒê√£ ƒë√°nh d·∫•u ƒë√£ tr·∫£ th∆∞·ªüng!');
    } catch (error) {
        console.error('Mark paid error:', error);
        alert('L·ªói: ' + error.message);
    }
}

        // Close modal when clicking outside
        document.getElementById('sessionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

async function saveRewardSettings() {
    const settings = {
        onTime: parseInt(document.getElementById('rewardOnTime').value),
        fast: parseInt(document.getElementById('rewardFast').value),
        complete100: parseInt(document.getElementById('reward100').value),
        complete90: parseInt(document.getElementById('reward90').value),
        examBonus: parseInt(document.getElementById('rewardExam').value)
    };
    
    try {
        await db.collection('settings').doc('rewards').set(settings);
        alert('‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t th∆∞·ªüng!');
    } catch (error) {
        console.error('Save error:', error);
        alert('L·ªói: ' + error.message);
    }
}

function closeScheduleModal() {
    document.getElementById('scheduleModal').classList.remove('active');
}

async function loadRewardSettingsToForm() {
    try {
        const doc = await db.collection('settings').doc('rewards').get();
        if (doc.exists) {
            const settings = doc.data();
            document.getElementById('rewardOnTime').value = settings.onTime || 2000;
            document.getElementById('rewardFast').value = settings.fast || 1000;
            document.getElementById('reward100').value = settings.complete100 || 2000;
            document.getElementById('reward90').value = settings.complete90 || 1000;
            document.getElementById('rewardExam').value = settings.examBonus || 1000;
        }
    } catch (error) {
        console.error('Load settings error:', error);
    }
}

// Load activities t·ª´ Firebase khi load page
async function loadActivities() {
    try {
        const doc = await db.collection('settings').doc('activities').get();
        if (doc.exists) {
            ACTIVITIES = doc.data().activities || ACTIVITIES;
        }
        renderActivities();
    } catch (error) {
        console.error('Load activities error:', error);
    }
}

// Render danh s√°ch activities
function renderActivities() {
    const container = document.getElementById('activitiesList');
    container.innerHTML = ACTIVITIES.map((act, idx) => `
        <div class="schedule-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <strong>${act.icon}</strong> ${act.name}
            </div>
            <div>
                <button class="btn btn-small" onclick="editActivity(${idx})">S·ª≠a</button>
                <button class="btn btn-small btn-danger" onclick="deleteActivity(${idx})">X√≥a</button>
            </div>
        </div>
    `).join('');
}

// Th√™m ho·∫°t ƒë·ªông m·ªõi
function addActivity() {
    const modal = document.getElementById('activityModal');
    const title = document.getElementById('activityModalTitle');
    const form = document.getElementById('activityForm');
    
    title.textContent = 'Th√™m Ho·∫°t ƒë·ªông m·ªõi';
    document.getElementById('activityName').value = '';
    document.getElementById('activityIcon').value = '';
    document.getElementById('activityIndex').value = '';
    
    modal.classList.add('active');
    
    form.onsubmit = handleActivitySubmit;
}

// Ch·ªânh s·ª≠a ho·∫°t ƒë·ªông
function editActivity(index) {
    const modal = document.getElementById('activityModal');
    const title = document.getElementById('activityModalTitle');
    const form = document.getElementById('activityForm');
    
    title.textContent = 'Ch·ªânh s·ª≠a Ho·∫°t ƒë·ªông';
    document.getElementById('activityName').value = ACTIVITIES[index].name;
    document.getElementById('activityIcon').value = ACTIVITIES[index].icon;
    document.getElementById('activityIndex').value = index;
    
    modal.classList.add('active');
    
    form.onsubmit = handleActivitySubmit;
}

// X·ª≠ l√Ω submit form ho·∫°t ƒë·ªông
async function handleActivitySubmit(e) {
    e.preventDefault();
    const name = document.getElementById('activityName').value;
    const icon = document.getElementById('activityIcon').value;
    const index = document.getElementById('activityIndex').value;
    
    if (!name || !icon) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!');
        return;
    }
    
    if (index === '') {
        // Add new
        ACTIVITIES.push({ name, icon });
    } else {
        // Edit
        ACTIVITIES[index] = { name, icon };
    }
    
    try {
        await db.collection('settings').doc('activities').set({ activities: ACTIVITIES });
        renderActivities();
        closeActivityModal();
        alert('ƒê√£ l∆∞u!');
    } catch (error) {
        console.error('Save activities error:', error);
        alert('L·ªói l∆∞u: ' + error.message);
    }
}

// X√≥a ho·∫°t ƒë·ªông
async function deleteActivity(index) {
    if (confirm('X√≥a ho·∫°t ƒë·ªông n√†y?')) {
        ACTIVITIES.splice(index, 1);
        try {
            await db.collection('settings').doc('activities').set({ activities: ACTIVITIES });
            renderActivities();
            alert('ƒê√£ x√≥a!');
        } catch (error) {
            console.error('Delete error:', error);
        }
    }
}

// Close modal ho·∫°t ƒë·ªông
function closeActivityModal() {
    document.getElementById('activityModal').classList.remove('active');
}
async function loadParentMessages() {
    const snap = await db.collection('messages').orderBy('timestamp', 'desc').get();
    const list = document.getElementById('parentMessagesList');
    list.innerHTML = snap.docs.map(doc => {
        const m = doc.data();
        const time = new Date(m.timestamp).toLocaleString('vi-VN');
        const isParent = m.from === 'parent';
        return `
            <div style="margin-bottom: 15px; text-align: ${isParent ? 'right' : 'left'};">
                <div style="display: inline-block; max-width: 80%; background: ${isParent ? '#667eea' : '#e3f2fd'}; color: ${isParent ? 'white' : '#333'}; padding: 12px 18px; border-radius: 18px;">
                    <small style="opacity: 0.8;">${isParent ? 'B·ªë m·∫π' : 'Con'} - ${time}</small><br>
                    ${m.text}
                </div>
            </div>
        `;
    }).join('');
}

async function sendParentMessage() {
    const text = document.getElementById('parentMessageInput').value.trim();
    if (!text) return;
    
    await db.collection('messages').add({
        text: text,
        from: 'parent',
        timestamp: new Date().toISOString()
    });
    document.getElementById('parentMessageInput').value = '';
    loadParentMessages();
}

// G·ªçi khi m·ªü tab
function switchTab(tab) {
    // ·∫®n h·∫øt tab + b·ªè active button
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // Hi·ªán tab ƒë∆∞·ª£c ch·ªçn
    document.getElementById('tab-' + tab).classList.add('active');
    event.target.classList.add('active');

    // G·ªåI H√ÄM LOAD T∆Ø∆†NG ·ª®NGl√≠ch
    if (tab === 'overview') renderOverview();
    if (tab === 'sessions') renderSessions();
    if (tab === 'stats') renderStats();
    if (tab === 'schedule') renderSchedule();
    if (tab === 'rewards') renderRewards();
    if (tab === 'settings') loadRewardSettingsToForm();
    if (tab === 'messages') loadParentMessages();   // ‚Üê D√íNG QUAN TR·ªåNG NH·∫§T
}

async function giveHotReward() {
    const amount = parseInt(document.getElementById('hotRewardAmount').value);
    const reason = document.getElementById('hotRewardReason').value.trim();
    
    if (!amount || amount <= 0) {
        alert('‚ùå Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!');
        return;
    }
    
    if (!reason) {
        alert('‚ùå Vui l√≤ng nh·∫≠p l√Ω do th∆∞·ªüng!');
        return;
    }
    
    if (!confirm(`X√°c nh·∫≠n t·∫∑ng ${amount.toLocaleString('vi-VN')}ƒë cho con?\nL√Ω do: ${reason}`)) {
        return;
    }
    
    try {
        // T·∫°o session th∆∞·ªüng n√≥ng
        const hotRewardSession = {
            id: 'hotreward_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            date: new Date().toISOString(),
            subject: 'üéÅ Th∆∞·ªüng n√≥ng t·ª´ ba m·∫π',
            mode: 'hot_reward',
            time: 0,
            targetTime: 0,
            completionRate: 100,
            reward: amount,
            questions: [],
            aiChatCount: 0,
            callParentCount: 0,
            callParentLogs: [],
            feedback: reason,
            paid: false,
            paidDate: null,
            submittedFiles: null
        };
        
        // L∆∞u l√™n Firebase
        await db.collection('sessions').add(hotRewardSession);
        
        // C·∫≠p nh·∫≠t local state
        sessionHistory.unshift(hotRewardSession);
        
        // Reset form
        document.getElementById('hotRewardAmount').value = '';
        document.getElementById('hotRewardReason').value = '';
        
        // Reload c√°c ph·∫ßn li√™n quan
        await loadData();
        updateOverview();
        renderRewards();
        
        alert(`‚úÖ ƒê√£ t·∫∑ng th∆∞·ªüng ${amount.toLocaleString('vi-VN')}ƒë cho con!\n\nCon s·∫Ω th·∫•y ngay tr√™n m√†n h√¨nh c·ªßa m√¨nh! üéâ`);
        
    } catch (error) {
        console.error('Hot reward error:', error);
        alert('‚ùå L·ªói: ' + error.message);
    }
}

// S·ª≠a s·ªë ti·ªÅn th∆∞·ªüng
async function editReward(sessionId) {
    const session = sessionHistory.find(s => s.id === sessionId);
    if (!session) return;
    
    const currentReward = session.reward || 0;
    const newReward = prompt(
        `S·ª≠a ti·ªÅn th∆∞·ªüng cho: ${session.subject}\n` +
        `S·ªë ti·ªÅn hi·ªán t·∫°i: ${currentReward.toLocaleString('vi-VN')}ƒë\n\n` +
        `Nh·∫≠p s·ªë ti·ªÅn m·ªõi (ho·∫∑c 0 ƒë·ªÉ x√≥a):`,
        currentReward
    );
    
    if (newReward === null) return; // User clicked Cancel
    
    const amount = parseInt(newReward);
    if (isNaN(amount) || amount < 0) {
        alert('‚ùå S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá!');
        return;
    }
    
    const reason = prompt(
        `L√Ω do thay ƒë·ªïi t·ª´ ${currentReward.toLocaleString('vi-VN')}ƒë ‚Üí ${amount.toLocaleString('vi-VN')}ƒë:`,
        'ƒêi·ªÅu ch·ªânh do l·ªói h·ªá th·ªëng'
    );
    
    if (!reason || !reason.trim()) {
        alert('‚ùå Vui l√≤ng nh·∫≠p l√Ω do!');
        return;
    }
    
    if (!confirm(
        `X√°c nh·∫≠n s·ª≠a ti·ªÅn th∆∞·ªüng?\n\n` +
        `B√†i: ${session.subject}\n` +
        `C≈©: ${currentReward.toLocaleString('vi-VN')}ƒë\n` +
        `M·ªõi: ${amount.toLocaleString('vi-VN')}ƒë\n` +
        `L√Ω do: ${reason}`
    )) {
        return;
    }
    
    try {
        // C·∫≠p nh·∫≠t Firebase
        await db.collection('sessions').doc(sessionId).update({
            reward: amount,
            editHistory: firebase.firestore.FieldValue.arrayUnion({
                oldReward: currentReward,
                newReward: amount,
                reason: reason,
                editedBy: 'parent',
                editedAt: new Date().toISOString()
            })
        });
        
        // C·∫≠p nh·∫≠t local state
        session.reward = amount;
        if (!session.editHistory) session.editHistory = [];
        session.editHistory.push({
            oldReward: currentReward,
            newReward: amount,
            reason: reason,
            editedBy: 'parent',
            editedAt: new Date().toISOString()
        });
        
        // Reload
        await loadData();
        updateOverview();
        renderRewards();
        
        alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t ti·ªÅn th∆∞·ªüng!\n${currentReward.toLocaleString('vi-VN')}ƒë ‚Üí ${amount.toLocaleString('vi-VN')}ƒë`);
        
    } catch (error) {
        console.error('Edit reward error:', error);
        alert('‚ùå L·ªói: ' + error.message);
    }
}

// X√≥a b·∫£n ghi ti·ªÅn th∆∞·ªüng
async function deleteReward(sessionId) {
    const session = sessionHistory.find(s => s.id === sessionId);
    if (!session) return;
    
    const reason = prompt(
        `‚ö†Ô∏è X√ìA HO√ÄN TO√ÄN b·∫£n ghi ti·ªÅn th∆∞·ªüng:\n\n` +
        `B√†i: ${session.subject}\n` +
        `Ng√†y: ${new Date(session.date).toLocaleString('vi-VN')}\n` +
        `Ti·ªÅn: ${session.reward.toLocaleString('vi-VN')}ƒë\n\n` +
        `Nh·∫≠p l√Ω do x√≥a:`,
        'L·ªói h·ªá th·ªëng / Ch·∫•m tr√πng'
    );
    
    if (!reason || !reason.trim()) {
        alert('‚ùå Ph·∫£i nh·∫≠p l√Ω do x√≥a!');
        return;
    }
    
    if (!confirm(
        `üö® X√ÅC NH·∫¨N X√ìA Vƒ®NH VI·ªÑN?\n\n` +
        `B√†i: ${session.subject}\n` +
        `Ti·ªÅn: ${session.reward.toLocaleString('vi-VN')}ƒë\n` +
        `L√Ω do: ${reason}\n\n` +
        `‚ö†Ô∏è H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!`
    )) {
        return;
    }
    
    try {
        // L∆∞u log x√≥a tr∆∞·ªõc khi x√≥a
        await db.collection('deletedSessions').add({
            ...session,
            deletedBy: 'parent',
            deletedAt: new Date().toISOString(),
            deleteReason: reason
        });
        
        // X√≥a kh·ªèi Firebase
        await db.collection('sessions').doc(sessionId).delete();
        
        // X√≥a kh·ªèi local state
        const index = sessionHistory.findIndex(s => s.id === sessionId);
        if (index > -1) {
            sessionHistory.splice(index, 1);
        }
        
        // Reload
        await loadData();
        updateOverview();
        renderRewards();
        renderSessions();
        
        alert(`‚úÖ ƒê√£ x√≥a b·∫£n ghi!\n\nL√Ω do: ${reason}\n\n(ƒê√£ l∆∞u v√†o th√πng r√°c ƒë·ªÉ ki·ªÉm tra sau)`);
        
    } catch (error) {
        console.error('Delete reward error:', error);
        alert('‚ùå L·ªói: ' + error.message);
    }
}
    </script>
<!-- Modal ch·ªânh s·ª≠a/th√™m l·ªãch -->
<div class="modal" id="scheduleModal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeScheduleModal()">&times;</button>
        <h2 id="modalTitle" style="color: #667eea; margin-bottom: 20px;">Ch·ªânh s·ª≠a M√¥n h·ªçc</h2>
        <form id="scheduleForm">
            <div class="input-group">
                <label>Th·ªùi gian (v√≠ d·ª•: 16h30-17h15):</label>
                <input type="text" id="editTime" required>
            </div>
            <div class="input-group">
                <label>T√™n m√¥n h·ªçc:</label>
                <input type="text" id="editSubject" required>
            </div>
            <div class="input-group">
                <label>Lo·∫°i:</label>
                <select id="editType" required>
                    <option value="homework">üìù B√†i t·∫≠p</option>
                    <option value="class">üè´ L·ªõp h·ªçc</option>
                    <option value="break">‚òï Ngh·ªâ ng∆°i</option>
                </select>
            </div>
            <input type="hidden" id="editDay"> <!-- ·∫®n: l∆∞u ng√†y -->
            <input type="hidden" id="editIndex"> <!-- ·∫®n: l∆∞u index n·∫øu edit -->
            <button type="submit" class="btn btn-success" style="width: 100%;">üíæ L∆∞u thay ƒë·ªïi</button>
        </form>
    </div>
</div>
</body>
</html>
