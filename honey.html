<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc t·∫≠p h√¥m nay üìö</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .date-display {
            color: #666;
            font-size: 1.2em;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .subject-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .subject-card.completed {
            opacity: 0.7;
            background: #f0f0f0;
        }

        .subject-card.completed::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4caf50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .subject-card.in-progress {
            border: 3px solid #ff9800;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4); }
            50% { box-shadow: 0 5px 25px rgba(255, 152, 0, 0.8); }
        }

        .subject-card.class-type {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .time-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .subject-name {
            font-size: 1.5em;
            color: #333;
            margin: 10px 0;
            font-weight: bold;
        }

        .subject-type {
            color: #999;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #4caf50;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .mode-card {
            border: 3px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .mode-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mode-card .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .mode-card .title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .mode-card .description {
            font-size: 0.9em;
            color: #666;
        }

        .exam-mode-screen {
            background: #000;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .exam-mode-screen.active {
            display: flex;
        }

        .exam-timer {
            font-size: 8em;
            color: #fff;
            font-weight: bold;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
            display: none;
        }

        .exam-timer.warning {
            color: #ff9800;
        }

        .exam-timer.danger {
            color: #f44336;
        }

        .exam-subject {
            font-size: 2em;
            color: #aaa;
            margin-bottom: 50px;
        }

        .exam-finish-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 15px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }

        .exam-finish-btn:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .timer-display {
            font-size: 3em;
            text-align: center;
            color: #667eea;
            margin: 20px 0;
            font-weight: bold;
        }

        .timer-display.warning {
            color: #ff9800;
            animation: blink 1s infinite;
        }

        .timer-display.danger {
            color: #f44336;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .question-tracker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .question-item {
            aspect-ratio: 1;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .question-item:hover {
            transform: scale(1.1);
        }

        .question-item.completed {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .chat-popup {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            flex-direction: column;
        }

        .chat-popup.active {
            display: flex;
        }

        .chat-header {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .prompt-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .copy-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .break-activities {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .activity-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .activity-card:hover {
            transform: scale(1.05);
        }

        .activity-card .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stats-summary {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .reward-display {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 1.5em;
            margin: 20px 0;
        }

        .encouragement {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.1em;
            text-align: center;
            font-weight: bold;
        }

        .alert-banner {
            background: #ff5252;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
            align-items: center;
            gap: 15px;
            animation: shake 0.5s;
        }

        .alert-banner.active {
            display: flex;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0;
            padding: 0 10px;
        }

        .nav-tabs .tab-btn {
            background: white;
            color: #667eea;
            border: 3px solid #667eea;
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            min-width: 180px;
            white-space: nowrap;
        }

        .nav-tabs .tab-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .nav-tabs .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .chat-popup {
                width: 90%;
                right: 5%;
            }
            
            .modal-content {
                padding: 20px;
            }

            .exam-timer {
                font-size: 4em;
            }

            .mode-selection {
                grid-template-columns: 1fr;
            }

            .nav-tabs .tab-btn {
                font-size: 1em;
                padding: 12px 18px;
                min-width: 150px;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Xin ch√†o, M·∫≠t Ong! üëã</h1>
            <div class="date-display" id="dateDisplay"></div>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('schedule', this)">
                L·ªãch h·ªçc h√¥m nay
            </button>
            <button class="tab-btn" onclick="showTab('stats', this)">
                Ti·ªÅn th∆∞·ªüng c·ªßa con
            </button>
            <button class="tab-btn" onclick="showTab('messages', this)">
                Tin nh·∫Øn b·ªë m·∫π
            </button>
        </div>
        
        <div class="alert-banner" id="alertBanner">
            <span style="font-size: 2em;">‚ö†Ô∏è</span>
            <span id="alertMessage"></span>
        </div>

        <div id="scheduleContainer" class="schedule-grid"></div>
        
        <!-- TAB TI·ªÄN TH∆Ø·ªûNG -->
        <div id="tab-stats" class="tab-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 25px 15px;">
                <div class="card" style="text-align: center; border: 3px solid #ff9a9e;">
                    <div style="font-size: 4.5em; margin-bottom: 10px;">üí∞</div>
                    <div style="color: #666; font-size: 1.2em; margin-bottom: 8px;">H√¥m nay</div>
                    <div id="kidTodayReward" style="font-size: 3.2em; font-weight: bold; color: #e91e63;">0ƒë</div>
                </div>

                <div class="card" style="text-align: center; border: 3px solid #a18cd1;">
                    <div style="font-size: 4em; margin-bottom: 10px;">üìÖ</div>
                    <div style="color: #666; font-size: 1.2em; margin-bottom: 8px;">Tu·∫ßn n√†y</div>
                    <div id="kidWeekReward" style="font-size: 3.2em; font-weight: bold; color: #9c27b0;">0ƒë</div>
                </div>

                <div class="card" style="text-align: center; border: 3px solid #667eea;">
                    <div style="font-size: 4em; margin-bottom: 10px;">üèÜ</div>
                    <div style="color: #666; font-size: 1.2em; margin-bottom: 8px;">T·ªïng c·ªông</div>
                    <div id="kidTotalReward" style="font-size: 3.5em; font-weight: bold; color: #667eea;">0ƒë</div>
                </div>
            </div>

            <div class="card" style="margin: 25px 15px;">
                <h2 style="color: #667eea; text-align: center; font-size: 1.8em; margin-bottom: 20px;">
                    L·ªãch s·ª≠ nh·∫≠n th∆∞·ªüng
                </h2>
                <div id="kidRewardHistory" style="max-height: 420px; overflow-y: auto;"></div>
            </div>

            <div class="card" style="margin: 25px 15px;">
                <h2 style="color: #667eea; text-align: center; font-size: 1.8em; margin-bottom: 20px;">
                    T·ª± ph·∫£n √°nh h√¥m nay
                </h2>
                <textarea id="reflectionText" placeholder="H√¥m nay con h·ªçc t·ªët ·ªü ƒë√¢u? C·∫ßn c·∫£i thi·ªán g√¨ n√®?..." 
                          style="width: 100%; height: 140px; padding: 20px; border-radius: 20px; border: 3px solid #ddd; font-size: 1.2em; background: #f8f9ff;"></textarea>
                <button class="btn btn-success" onclick="saveReflection()" 
                        style="width: 100%; padding: 18px; font-size: 1.5em; margin-top: 15px; border-radius: 50px; background: linear-gradient(135deg, #667eea, #764ba2);">
                    G·ª≠i cho b·ªë m·∫π
                </button>
                <div id="reflectionStatus" style="text-align: center; margin-top: 12px; color: #4caf50; font-weight: bold;"></div>
            </div>
        </div>

        <!-- TAB TIN NH·∫ÆN -->
        <div id="tab-messages" class="tab-content">
            <div class="card" style="margin: 25px 15px; padding: 30px;">
                <h2 style="color: #667eea; font-size: 2.2em; margin-bottom: 25px; text-align: center;">
                    Tin nh·∫Øn t·ª´ b·ªë m·∫π
                </h2>
                <div id="messagesList" style="background: #f8f5ff; border-radius: 20px; padding: 20px; min-height: 300px; max-height: 500px; overflow-y: auto; margin-bottom: 25px;"></div>
                <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: 0 8px 25px rgba(102,126,234,0.15);">
                    <textarea id="messageToParent" placeholder="Con mu·ªën nh·∫Øn g√¨ v·ªõi b·ªë m·∫π n√†o..." 
                              style="width: 100%; height: 110px; padding: 18px; border-radius: 18px; border: 3px solid #667eea; font-size: 1.2em; resize: none;"></textarea>
                    <button class="btn btn-success" onclick="sendMessage()" 
                            style="width: 100%; padding: 18px; font-size: 1.5em; margin-top: 15px; border-radius: 50px; background: linear-gradient(135deg, #667eea, #764ba2);">
                        G·ª≠i tin nh·∫Øn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ MODAL SETUP - C·∫§U TR√öC ƒê·∫¶Y ƒê·ª¶ -->
    <div class="modal" id="setupModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('setupModal')">&times;</button>
            <h2 style="color: #667eea; margin-bottom: 20px;">Chu·∫©n b·ªã l√†m b√†i</h2>
            <div id="setupForm"></div>
        </div>
    </div>

    <!-- Modal for Class -->
    <div class="modal" id="classModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('classModal')">&times;</button>
            <h2 style="color: #667eea; margin-bottom: 20px;">üìö Ti·∫øt h·ªçc t·∫°i l·ªõp</h2>
            <div id="classInfo"></div>
            <button class="btn btn-success" onclick="markClassComplete()">‚úì ƒê√£ ho√†n th√†nh</button>
        </div>
    </div>

    <!-- Modal for Working -->
    <div class="modal" id="workModal">
        <div class="modal-content">
            <h2 style="color: #667eea; margin-bottom: 20px;" id="workTitle"></h2>
            <div class="timer-display" id="timerDisplay">00:00</div>
            <div class="question-tracker" id="questionTracker"></div>
            <div class="action-buttons">
                <button class="btn" onclick="openChatAI()">üí¨ Chat AI</button>
                <button class="btn btn-secondary" onclick="callParent('m·∫π')">üìû G·ªçi m·∫π</button>
                <button class="btn btn-secondary" onclick="callParent('b·ªë')">üìû G·ªçi b·ªë</button>
            </div>
            <button class="btn btn-success" onclick="finishWork()" style="width: 100%; margin-top: 20px;">Ho√†n th√†nh</button>
        </div>
    </div>

    <!-- Exam Mode Screen -->
    <div class="exam-mode-screen" id="examModeScreen">
        <div class="exam-subject" id="examSubject"></div>
        <div class="exam-timer" id="examTimer">00:00</div>
        <button class="exam-finish-btn" onclick="finishWork()">Ho√†n th√†nh</button>
    </div>

    <!-- Modal for Results -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeResultModal()">&times;</button>
            <h2 style="color: #667eea; margin-bottom: 20px;">üéâ K·∫øt qu·∫£ l√†m b√†i</h2>
            <div id="resultContent"></div>
        </div>
    </div>

    <!-- Modal for Break -->
    <div class="modal" id="breakModal">
        <div class="modal-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">‚òï Ngh·ªâ gi·∫£i lao</h2>
            <div class="timer-display" id="breakTimer">05:00</div>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Ch·ªçn ho·∫°t ƒë·ªông gi·∫£i tr√≠:</p>
            <div class="break-activities" id="breakActivitiesContainer">
    <!-- S·∫Ω ƒë∆∞·ª£c load ƒë·ªông t·ª´ Firebase -->
</div>
            <button class="btn btn-secondary" onclick="skipBreak()" style="width: 100%; margin-top: 20px;">B·ªè qua ngh·ªâ</button>
        </div>
    </div>

    <!-- Chat Popup -->
    <div class="chat-popup" id="chatPopup">
        <div class="chat-header">
            <span>üí¨ Chat v·ªõi Claude AI</span>
            <button class="close-btn" onclick="closeChatAI()" style="position: static; color: white;">&times;</button>
        </div>
        <div class="chat-body">
            <p style="margin-bottom: 15px; color: #666;">Sao ch√©p prompt b√™n d∆∞·ªõi v√† d√°n v√†o Claude.ai:</p>
            <div class="prompt-box" id="promptBox"></div>
            <button class="copy-btn" onclick="copyPrompt()">üìã Sao ch√©p</button>
            <button class="btn" onclick="openClaudeAI()" style="width: 100%; margin-top: 15px;">M·ªü Claude.ai</button>
        </div>
    </div>

   <audio id="alarmSound" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuCzvLZizUHGGS56eObTA0PPKXh8bllHAU2jdXvx3YpBSh+zPDajzsIFmm98OScTQ0PN6Xh8bllHAU2jdXvx3YpBSh+zPDajzsIFmm98OScTQ0PN6Xh8bllHAU2jdXvx3YpBSh+zPDajzsIFmm98OScTQ0PN6Xh8bllHAU2jdXvx3YpBSh+zPDajzsIFmm98OScTQ0PN6Xh8bllHAU2jdXvx3YpBSh+zPDajzsIFmm98OScTQ0PN6Xh8bllHAU2jdXvx3YpBSh+zPDajzsIFmm98OScTQ0P" preload="auto"></audio>

<script>
    // Schedule data
    // Schedule data - S·∫º LOAD T·ª™ FIREBASE
let SCHEDULE = {};

// Load schedule t·ª´ Firebase
async function loadScheduleFromFirebase() {
    try {
        const doc = await db.collection('settings').doc('schedule').get();
        if (doc.exists && doc.data().schedule) {
            SCHEDULE = doc.data().schedule;
            console.log('‚úÖ ƒê√£ load schedule t·ª´ Firebase');
        } else {
            console.log('‚ö†Ô∏è Ch∆∞a c√≥ schedule tr√™n Firebase');
            SCHEDULE = {}; // ƒê·ªÉ tr·ªëng, ho·∫∑c c√≥ th·ªÉ set default
        }
    } catch (error) {
        console.error('‚ùå Load schedule error:', error);
        SCHEDULE = {};
    }
}

    // Form templates
    const FORM_TEMPLATES = {
        'FCE Reading': {parts: 7, questions: [8,6,6,7,6,6,10]},
        'FCE Writing': {parts: 2, questions: [1,1]},
        'FCE Listening': {parts: 4, questions: [8,10,5,7]},
        'FCE Speaking': {parts: 4, questions: [1,1,1,1]},
        'To√°n c√¥ H·∫£i - Ch·ªØa ƒë·ªÅ': {parts: 1, questions: [15]}
    };
// Th√™m bi·∫øn global
let ACTIVITIES = [];
let REWARD_SETTINGS = {
    onTime: 2000,
    fast: 1000,
    complete100: 2000,
    complete90: 1000,
    examBonus: 1000
};
// Load activities t·ª´ Firebase
async function loadActivitiesFromFirebase() {
    try {
        const doc = await db.collection('settings').doc('activities').get();
        if (doc.exists && doc.data().activities) {
            ACTIVITIES = doc.data().activities;
            console.log('‚úÖ ƒê√£ load activities t·ª´ Firebase');
        } else {
            // Default n·∫øu ch∆∞a c√≥
            ACTIVITIES = [
                { name: 'Nh·∫£y theo nh·∫°c', icon: 'üíÉ' },
                { name: 'Ch·∫°y c·∫ßu thang', icon: 'üèÉ' },
                { name: 'B√¥i kem cho b·ªë', icon: 'ü§ó' },
                { name: 'U·ªëng n∆∞·ªõc', icon: 'üíß' }
            ];
            console.log('‚ö†Ô∏è D√πng activities m·∫∑c ƒë·ªãnh');
        }
    } catch (error) {
        console.error('‚ùå Load activities error:', error);
        ACTIVITIES = [];
    }
}
async function loadRewardSettings() {
    try {
        const doc = await db.collection('settings').doc('rewards').get();
        if (doc.exists) {
            REWARD_SETTINGS = doc.data();
            console.log('‚úÖ ƒê√£ load c√†i ƒë·∫∑t th∆∞·ªüng t·ª´ Firebase:', REWARD_SETTINGS);
        } else {
            // L∆∞u gi√° tr·ªã m·∫∑c ƒë·ªãnh l√™n Firebase l·∫ßn ƒë·∫ßu
            await db.collection('settings').doc('rewards').set(REWARD_SETTINGS);
            console.log('‚ÑπÔ∏è ƒê√£ t·∫°o c√†i ƒë·∫∑t th∆∞·ªüng m·∫∑c ƒë·ªãnh');
        }
    } catch (error) {
        console.error('‚ùå Load reward settings error:', error);
    }
}
// Render activities v√†o break modal
function renderBreakActivities() {
    const container = document.getElementById('breakActivitiesContainer');
    if (!container) return;
    
    container.innerHTML = ACTIVITIES.map(act => `
        <div class="activity-card" onclick="selectActivity('${act.name}')">
            <div class="icon">${act.icon}</div>
            <div>${act.name}</div>
        </div>
    `).join('');
}

    // AI Prompts
    const AI_PROMPTS = {
        'To√°n': `Ch√†o Claude! Em ƒëang l√†m b√†i to√°n l·ªõp 8 v√† g·∫∑p kh√≥ khƒÉn. Em s·∫Ω ch·ª•p/m√¥ t·∫£ ƒë·ªÅ b√†i.
B·∫°n h√£y:
1. ƒê·ªçc k·ªπ ƒë·ªÅ b√†i v√† x√°c nh·∫≠n em hi·ªÉu ƒë·ªÅ ƒë√∫ng ch∆∞a
2. G·ª£i √Ω h∆∞·ªõng gi·∫£i (KH√îNG gi·∫£i lu√¥n), ƒë·∫∑t c√¢u h·ªèi g·ª£i m·ªü ƒë·ªÉ em t·ª± suy nghƒ©
3. N·∫øu em v·∫´n ch∆∞a ra, h√£y gi·∫£i th√≠ch t·ª´ng b∆∞·ªõc nh·ªè, d·ª´ng l·∫°i ƒë·ªÉ em l√†m ti·∫øp
4. Khuy·∫øn kh√≠ch em t·ª± l√†m, ch·ªâ h∆∞·ªõng d·∫´n khi th·ª±c s·ª± c·∫ßn
H√£y ki√™n nh·∫´n v√† ƒë·ªông vi√™n em nh√©!`,

        'FCE Reading': `Ch√†o Claude! Em ƒëang luy·ªán FCE Reading v√† c√≥ c√¢u kh√≥. Em s·∫Ω ch·ª•p ƒëo·∫°n vƒÉn v√† c√¢u h·ªèi.
B·∫°n h√£y:
1. Gi·∫£i th√≠ch t·ª´ v·ª±ng kh√≥ (n·∫øu c√≥) b·∫±ng ti·∫øng Vi·ªát ƒë∆°n gi·∫£n
2. Ph√¢n t√≠ch c·∫•u tr√∫c c√¢u ph·ª©c t·∫°p
3. Ch·ªâ ra keywords trong c√¢u h·ªèi v√† ƒëo·∫°n vƒÉn
4. H∆∞·ªõng d·∫´n k·ªπ thu·∫≠t l√†m d·∫°ng b√†i n√†y
5. G·ª¢I √ù ƒë√°p √°n (kh√¥ng n√≥i th·∫≥ng), ƒë·ªÉ em t·ª± ch·ªçn
M·ª•c ti√™u c·ªßa em l√† ƒë·∫°t C1 (180 ƒëi·ªÉm) nh√©!`,

        'FCE Writing': `Ch√†o Claude! Em c·∫ßn feedback cho b√†i FCE Writing.
Y√™u c·∫ßu ƒë·ªÅ b√†i: [em s·∫Ω paste]
B√†i l√†m c·ªßa em: [em s·∫Ω paste/ch·ª•p]

B·∫°n h√£y ƒë√°nh gi√° theo 4 ti√™u ch√≠ FCE:
1. Content (C√≥ ƒë·ªß √Ω? C√≥ tr·∫£ l·ªùi ƒë√∫ng y√™u c·∫ßu kh√¥ng?)
2. Communicative Achievement (Phong c√°ch, gi·ªçng vƒÉn ph√π h·ª£p?)
3. Organisation (B·ªë c·ª•c r√µ r√†ng? Linking words?)
4. Language (Ng·ªØ ph√°p, t·ª´ v·ª±ng ƒëa d·∫°ng? Sai s√≥t?)

Cho ƒëi·ªÉm d·ª± ki·∫øn (A2/B1/B2/C1) v√† G·ª¢I √ù C·∫¢I THI·ªÜN C·ª§ TH·ªÇ ƒë·ªÉ l√™n C1.
Kh√¥ng vi·∫øt l·∫°i to√†n b·ªô b√†i gi√∫p em, ch·ªâ s·ª≠a 2-3 c√¢u m·∫´u th√¥i nh√©!`,

        'FCE Listening': `Ch√†o Claude! Em ƒëang luy·ªán FCE Listening v√† c·∫ßn gi·∫£i th√≠ch.
Em s·∫Ω m√¥ t·∫£ c√¢u h·ªèi v√† nh·ªØng g√¨ em nghe ƒë∆∞·ª£c.

B·∫°n h√£y:
1. Gi·∫£i th√≠ch t·ª´ v·ª±ng/c·ª•m t·ª´ kh√≥ trong audio
2. Ph√¢n t√≠ch t·∫°i sao ƒë√°p √°n ƒë√∫ng l√† ... (n·∫øu em bi·∫øt ƒë√°p √°n)
3. H∆∞·ªõng d·∫´n k·ªπ thu·∫≠t nghe ƒë·ªÉ b·∫Øt ƒë∆∞·ª£c th√¥ng tin
4. G·ª£i √Ω c√°ch c·∫£i thi·ªán Listening ƒë·ªÉ ƒë·∫°t C1

M·ª•c ti√™u: C1 (180 ƒëi·ªÉm)`,

        'FCE Speaking': `Ch√†o Claude! Em mu·ªën luy·ªán FCE Speaking.
Part [1/2/3/4]: [em m√¥ t·∫£]

B·∫°n ƒë√≥ng vai examiner:
1. ƒê∆∞a c√¢u h·ªèi theo format FCE
2. Sau khi em tr·∫£ l·ªùi, cho feedback ng·∫Øn v·ªÅ:
   - Fluency (tr√¥i ch·∫£y?)
   - Grammar & Vocabulary (ƒëa d·∫°ng?)
   - Pronunciation tips (qua text, g·ª£i √Ω ph√°t √¢m chu·∫©n)
3. G·ª£i √Ω c√°ch tr·∫£ l·ªùi t·ªët h∆°n ƒë·ªÉ ƒë·∫°t C1
4. Ti·∫øp t·ª•c c√¢u h·ªèi kh√°c

H√£y nghi√™m kh·∫Øc nh∆∞ng ƒë·ªông vi√™n em nh√©!`,

        'Y√™n H√≤a': `Ch√†o Claude! Em ƒëang l√†m b√†i t·∫≠p Y√™n H√≤a v√† c·∫ßn tr·ª£ gi√∫p.
Em s·∫Ω ch·ª•p/m√¥ t·∫£ ƒë·ªÅ b√†i.

B·∫°n h√£y:
1. ƒê·ªçc k·ªπ ƒë·ªÅ v√† x√°c nh·∫≠n em hi·ªÉu ƒë√∫ng ch∆∞a
2. G·ª£i √Ω h∆∞·ªõng l√†m (kh√¥ng gi·∫£i lu√¥n)
3. Gi·∫£i th√≠ch c√°c kh√°i ni·ªám n·∫øu em ch∆∞a r√µ
4. Khuy·∫øn kh√≠ch em t·ª± l√†m

H√£y ki√™n nh·∫´n v·ªõi em nh√©!`
    };

    // Global state
    let currentSession = null;
    let timerInterval = null;
    let breakTimerInterval = null;
    let workStartTime = null;
    let completedSubjects = [];
    let breakWarningTimeout = null;

    // Initialize
    window.onload = async function() {
    await loadScheduleFromFirebase();
    await loadActivitiesFromFirebase();
await loadRewardSettings();
    displayDate();
    loadSchedule();
    loadProgress();
};

    function displayDate() {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const daysVi = ['Ch·ªß nh·∫≠t', 'Th·ª© hai', 'Th·ª© ba', 'Th·ª© t∆∞', 'Th·ª© nƒÉm', 'Th·ª© s√°u', 'Th·ª© b·∫£y'];
        const today = new Date();
        const dayName = days[today.getDay()];
        const dayNameVi = daysVi[today.getDay()];
        const dateStr = today.toLocaleDateString('vi-VN');
        
        document.getElementById('dateDisplay').textContent = `${dayNameVi}, ${dateStr}`;
        
        return dayName;
    }

    function loadSchedule() {
        const dayName = displayDate();
        const todaySchedule = SCHEDULE[dayName] || [];
        const container = document.getElementById('scheduleContainer');
        container.innerHTML = '';

        todaySchedule.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'subject-card';
            
            if (item.type === 'class') {
                card.className += ' class-type';
            }
            
            if (completedSubjects.includes(index)) {
                card.className += ' completed';
            }
            
            if (currentSession && currentSession.index === index) {
                card.className += ' in-progress';
            }

            let typeLabel = '';
            if (item.type === 'homework') typeLabel = 'üìù B√†i t·∫≠p v·ªÅ nh√†';
            else if (item.type === 'class') typeLabel = 'üè´ H·ªçc t·∫°i l·ªõp';
            else if (item.type === 'break') typeLabel = '‚òï Ngh·ªâ ng∆°i';

            card.innerHTML = `
                <div class="time-badge">${item.time}</div>
                <div class="subject-name">${item.subject}</div>
                <div class="subject-type">${typeLabel}</div>
            `;

            card.onclick = () => handleSubjectClick(item, index);
            container.appendChild(card);
        });
    }

    function handleSubjectClick(subject, index) {
        if (completedSubjects.includes(index)) {
            alert('M√¥n n√†y ƒë√£ ho√†n th√†nh r·ªìi! üéâ');
            return;
        }

        if (subject.type === 'break') {
            alert('ƒê√¢y l√† th·ªùi gian ngh·ªâ ng∆°i. H√£y th∆∞ gi√£n nh√©! üòä');
            return;
        }

        if (subject.type === 'class') {
            showClassModal(subject, index);
        } else if (subject.type === 'homework') {
            showSetupModal(subject, index);
        }
    }

    function showClassModal(subject, index) {
        const modal = document.getElementById('classModal');
        const info = document.getElementById('classInfo');
        
        info.innerHTML = `
            <p style="font-size: 1.3em; margin: 20px 0;"><strong>${subject.subject}</strong></p>
            <p style="font-size: 1.1em; color: #666; margin: 15px 0;">‚è∞ ${subject.time}</p>
            <p style="font-size: 1em; color: #ff9800; margin: 15px 0;">üìù ${subject.note || 'Nh·ªõ mang ƒë·∫ßy ƒë·ªß ƒë·ªì d√πng h·ªçc t·∫≠p'}</p>
        `;
        
        modal.classList.add('active');
        currentSession = {index, subject, type: 'class'};
    }

    function markClassComplete() {
        if (currentSession) {
            completedSubjects.push(currentSession.index);
            saveProgress();
            closeModal('classModal');
            loadSchedule();
            logActivity('Ho√†n th√†nh m√¥n h·ªçc t·∫°i l·ªõp', currentSession.subject.subject);
        }
    }

    function showSetupModal(subject, index) {
        const modal = document.getElementById('setupModal');
        const form = document.getElementById('setupForm');
        
        let formHTML = `
            <div class="input-group">
                <label>M√¥n h·ªçc:</label>
                <input type="text" value="${subject.subject}" disabled>
            </div>

            <div class="input-group">
                <label>Ch·∫ø ƒë·ªô l√†m b√†i:</label>
                <div class="mode-selection">
                    <div class="mode-card selected" onclick="selectMode('normal')" id="modeNormal">
                        <div class="icon">üìù</div>
                        <div class="title">L√†m b√†i th∆∞·ªùng</div>
                        <div class="description">C√≥ h·ªó tr·ª£ Chat AI, g·ªçi b·ªë m·∫π, theo d√µi c√¢u h·ªèi</div>
                    </div>
                    <div class="mode-card" onclick="selectMode('exam')" id="modeExam">
                        <div class="icon">üéØ</div>
                        <div class="title">Ch·∫ø ƒë·ªô luy·ªán thi</div>
                        <div class="description">M√†n h√¨nh ƒëen, ch·ªâ c√≥ ƒë·ªìng h·ªì, t·∫≠p trung cao ƒë·ªô nh∆∞ thi th·∫≠t</div>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label>Ch·ªçn d·∫°ng b√†i:</label>
                <select id="formTemplate" onchange="updateFormTemplate()">
                    <option value="">T·ª± nh·∫≠p s·ªë c√¢u</option>
        `;
        
        for (let template in FORM_TEMPLATES) {
            if (subject.subject.includes('FCE') && template.includes('FCE') ||
                subject.subject.includes('To√°n') && template.includes('To√°n') ||
                subject.subject.includes('Math') && template.includes('To√°n')) {
                formHTML += `<option value="${template}">${template}</option>`;
            }
        }
        
        formHTML += `
                </select>
            </div>
            <div class="input-group" id="customInputs">
                <label>S·ªë ph·∫ßn (parts):</label>
                <input type="number" id="numParts" value="1" min="1">
                <label style="margin-top: 10px;">S·ªë c√¢u m·ªói ph·∫ßn (c√°ch nhau b·ªüi d·∫•u ph·∫©y):</label>
                <input type="text" id="numQuestions" placeholder="VD: 10,15,20" value="10">
            </div>
            <div class="input-group">
                <label>Th·ªùi gian d·ª± ki·∫øn (ph√∫t):</label>
                <input type="number" id="targetTime" value="30" min="1">
                <p style="font-size: 0.9em; color: #666; margin-top: 5px;" id="aiSuggestion"></p>
            </div>
            <button class="btn btn-success" onclick="startWork()">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
        `;
        
        form.innerHTML = formHTML;
        modal.classList.add('active');
        currentSession = {index, subject, type: 'homework', mode: 'normal'};
        
        // AI suggestion for time
        suggestTime(subject.subject);
    }

    function selectMode(mode) {
        currentSession.mode = mode;
        document.getElementById('modeNormal').classList.toggle('selected', mode === 'normal');
        document.getElementById('modeExam').classList.toggle('selected', mode === 'exam');
    }

    function updateFormTemplate() {
        const template = document.getElementById('formTemplate').value;
        if (template && FORM_TEMPLATES[template]) {
            const data = FORM_TEMPLATES[template];
            document.getElementById('numParts').value = data.parts;
            document.getElementById('numQuestions').value = data.questions.join(',');
        }
    }

    function suggestTime(subject) {
        const suggestions = {
            'FCE Reading': 45,
            'FCE Writing': 40,
            'FCE Listening': 30,
            'FCE Speaking': 20,
            'To√°n': 45,
            'Math': 45,
            'Y√™n H√≤a': 30
        };
        
        let suggested = 30;
        for (let key in suggestions) {
            if (subject.includes(key)) {
                suggested = suggestions[key];
                break;
            }
        }
        
        document.getElementById('targetTime').value = suggested;
        document.getElementById('aiSuggestion').textContent = `üí° G·ª£i √Ω: ${suggested} ph√∫t d·ª±a tr√™n k·∫øt qu·∫£ t·ªët nh·∫•t c·ªßa b√©`;
    }

    function startWork() {
        const numParts = parseInt(document.getElementById('numParts').value);
        const questionsStr = document.getElementById('numQuestions').value;
        const targetTime = parseInt(document.getElementById('targetTime').value);
        
        const questions = questionsStr.split(',').map(q => parseInt(q.trim()));
        if (questions.length !== numParts) {
            alert('S·ªë c√¢u kh√¥ng kh·ªõp v·ªõi s·ªë ph·∫ßn!');
            return;
        }
        
        currentSession.numParts = numParts;
        currentSession.questions = questions;
        currentSession.targetTime = targetTime * 60; // convert to seconds
        currentSession.completedQuestions = [];
        currentSession.startTime = Date.now();
        currentSession.callParentLogs = [];
        
        closeModal('setupModal');
        
        if (currentSession.mode === 'exam') {
            showExamMode();
        } else {
            showWorkModal();
        }
    }
    
    function showExamMode() {
        const screen = document.getElementById('examModeScreen');
        const subjectEl = document.getElementById('examSubject');
        const timerEl = document.getElementById('examTimer');
        
        subjectEl.textContent = currentSession.subject.subject;
        timerEl.style.display = 'none'; // ·∫®n ƒë·ªìng h·ªì ban ƒë·∫ßu
        screen.classList.add('active');
        
        workStartTime = Date.now();
        timerInterval = setInterval(updateExamTimer, 1000);
        
        logActivity('B·∫Øt ƒë·∫ßu luy·ªán thi', currentSession.subject.subject);
    }

    function updateExamTimer() {
        const elapsed = Math.floor((Date.now() - workStartTime) / 1000);
        const timeLeft = currentSession.targetTime - elapsed;
        
        const display = document.getElementById('examTimer');
        const finishBtn = document.querySelector('.exam-finish-btn');
        
        // Hi·ªán ƒë·ªìng h·ªì khi c√≤n 15 ph√∫t (900 gi√¢y)
        if (timeLeft <= 900 && timeLeft > 0) {
            display.style.display = 'block';
            display.textContent = `${String(Math.floor(timeLeft / 60)).padStart(2, '0')}:${String(timeLeft % 60).padStart(2, '0')}`;
            display.classList.remove('warning', 'danger');
        }
        
        // H·∫øt gi·ªù
        if (elapsed >= currentSession.targetTime) {
            clearInterval(timerInterval);
            playAlarm();
            display.textContent = '00:00';
            display.style.display = 'block';
            
            // Hi·ªán h∆∞·ªõng d·∫´n n·ªôp b√†i
            const subjectEl = document.getElementById('examSubject');
            subjectEl.innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.5em; color: #ffc107; margin-bottom: 15px;">‚è∞ H·∫æT GI·ªú L√ÄM B√ÄI!</div>
                    <div style="font-size: 1em; color: #fff; text-align: left; line-height: 1.8;">
                        <strong style="color: #4caf50;">üìã 5 ph√∫t ƒë·ªÉ n·ªôp b√†i:</strong><br>
                        1Ô∏è‚É£ Ch·ª•p/Scan b√†i ‚Üí T·∫°o PDF<br>
                        2Ô∏è‚É£ G·ª≠i Zalo ‚Üí T·∫£i v·ªÅ m√°y t√≠nh<br>
                        3Ô∏è‚É£ B·∫•m n√∫t "N·ªôp b√†i" b√™n d∆∞·ªõi<br>
                    </div>
                </div>
            `;
            
            finishBtn.textContent = 'üì§ N·ªôp b√†i (5 ph√∫t)';
            finishBtn.style.display = 'block';
            
            // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c 5 ph√∫t cho scan & upload
            currentSession.uploadStartTime = Date.now();
            currentSession.uploadTimeLimit = 300; // 5 ph√∫t = 300 gi√¢y
            timerInterval = setInterval(updateUploadTimer, 1000);
            
            logActivity('‚è∞ H·∫øt gi·ªù l√†m b√†i', currentSession.subject.subject);
        }
    }

    function updateUploadTimer() {
        const elapsed = Math.floor((Date.now() - currentSession.uploadStartTime) / 1000);
        const timeLeft = currentSession.uploadTimeLimit - elapsed;
        
        const display = document.getElementById('examTimer');
        const finishBtn = document.querySelector('.exam-finish-btn');
        
        if (timeLeft > 0) {
            display.textContent = `C√≤n ${Math.floor(timeLeft / 60)}:${String(timeLeft % 60).padStart(2, '0')} ƒë·ªÉ n·ªôp`;
        } else {
            clearInterval(timerInterval);
            display.textContent = 'H·∫øt gi·ªù n·ªôp b√†i!';
            finishBtn.textContent = '‚úÖ Ho√†n th√†nh (kh√¥ng n·ªôp)';
        }
    }

    function showWorkModal() {
        const modal = document.getElementById('workModal');
        const title = document.getElementById('workTitle');
        const tracker = document.getElementById('questionTracker');
        
        title.textContent = currentSession.subject.subject;
        
        // Create question tracker
        tracker.innerHTML = '';
        let questionNum = 1;
        for (let i = 0; i < currentSession.numParts; i++) {
            for (let j = 0; j < currentSession.questions[i]; j++) {
                const qItem = document.createElement('div');
                qItem.className = 'question-item';
                qItem.textContent = questionNum;
                qItem.onclick = () => toggleQuestion(questionNum - 1, qItem);
                tracker.appendChild(qItem);
                questionNum++;
            }
        }
        
        modal.classList.add('active');
        startTimer();
    }

    function toggleQuestion(index, element) {
        if (currentSession.completedQuestions.includes(index)) {
            currentSession.completedQuestions = currentSession.completedQuestions.filter(q => q !== index);
            element.classList.remove('completed');
        } else {
            currentSession.completedQuestions.push(index);
            element.classList.add('completed');
            
            if (Math.random() > 0.7) {
                showEncouragement();
            }
        }
    }

    function showEncouragement() {
        const messages = [
            'üí™ L√†m t·ªët l·∫Øm!',
            'üåü Xu·∫•t s·∫Øc!',
            'üéØ Ch√≠nh x√°c!',
            'üöÄ Ti·∫øp t·ª•c nh√©!',
            '‚≠ê Gi·ªèi qu√°!',
            'üéâ Tuy·ªát v·ªùi!'
        ];
        
        const msg = messages[Math.floor(Math.random() * messages.length)];
        showAlert(msg, 2000);
    }

    function startTimer() {
        workStartTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - workStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        const display = document.getElementById('timerDisplay');
        display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        if (elapsed > currentSession.targetTime) {
            display.classList.add('danger');
            
            if ((elapsed - currentSession.targetTime) % 300 === 0 && (elapsed - currentSession.targetTime) > 0) {
                showOvertimeAlert(elapsed - currentSession.targetTime);
            }
        } else if (elapsed > currentSession.targetTime * 0.8) {
            display.classList.add('warning');
        }
    }

    function showOvertimeAlert(overtime) {
        const minutes = Math.floor(overtime / 60);
        showAlert(`‚ö†Ô∏è Con ƒë√£ l√†m qu√° ${minutes} ph√∫t so v·ªõi d·ª± ki·∫øn. Con c√≥ c·∫ßn tr·ª£ gi√∫p kh√¥ng?`, 10000);
        
        logActivity('C·∫£nh b√°o l√†m b√†i qu√° l√¢u', `Qu√° ${minutes} ph√∫t - ${currentSession.subject.subject}`);
    }

    function openChatAI() {
        const popup = document.getElementById('chatPopup');
        const promptBox = document.getElementById('promptBox');
        
        let prompt = '';
        const subjectName = currentSession.subject.subject;
        
        if (subjectName.includes('To√°n') || subjectName.includes('Math')) {
            prompt = AI_PROMPTS['To√°n'];
        } else if (subjectName.includes('FCE Reading')) {
            prompt = AI_PROMPTS['FCE Reading'];
        } else if (subjectName.includes('FCE Writing')) {
            prompt = AI_PROMPTS['FCE Writing'];
        } else if (subjectName.includes('FCE Listening')) {
            prompt = AI_PROMPTS['FCE Listening'];
        } else if (subjectName.includes('FCE Speaking')) {
            prompt = AI_PROMPTS['FCE Speaking'];
        } else if (subjectName.includes('Y√™n H√≤a')) {
            prompt = AI_PROMPTS['Y√™n H√≤a'];
        } else {
            prompt = `Ch√†o Claude! Em ƒëang l√†m b√†i ${subjectName} v√† c·∫ßn tr·ª£ gi√∫p. Em s·∫Ω m√¥ t·∫£ ƒë·ªÅ b√†i. H√£y gi√∫p em nh√©!`;
        }
        
        promptBox.textContent = prompt;
        popup.classList.add('active');
        
        logActivity('M·ªü chat AI', subjectName);
    }

    function closeChatAI() {
        document.getElementById('chatPopup').classList.remove('active');
    }

    function copyPrompt() {
        const prompt = document.getElementById('promptBox').textContent;
        navigator.clipboard.writeText(prompt).then(() => {
            alert('‚úÖ ƒê√£ sao ch√©p! H√£y d√°n v√†o Claude.ai nh√©!');
        });
    }

    function openClaudeAI() {
        window.open('https://claude.ai', '_blank');
    }

    function callParent(who) {
        const time = new Date().toLocaleTimeString('vi-VN');
        currentSession.callParentLogs.push({who, time});
        logActivity(`G·ªçi ${who}`, `${currentSession.subject.subject} - ${time}`);
        alert(`üìû ƒê√£ ghi nh·∫≠n: G·ªçi ${who} l√∫c ${time}`);
    }

    function finishWork() {
        clearInterval(timerInterval);
        
        const totalTime = Math.floor((Date.now() - workStartTime) / 1000);
        const totalQuestions = currentSession.questions.reduce((a, b) => a + b, 0);
        const completed = currentSession.mode === 'exam' ? totalQuestions : currentSession.completedQuestions.length;
        
        currentSession.totalTime = totalTime;
        currentSession.completionRate = (completed / totalQuestions * 100).toFixed(1);
        
        if (currentSession.mode === 'exam') {
            document.getElementById('examModeScreen').classList.remove('active');
        } else {
            closeModal('workModal');
        }
        
        showResultModal();
    }

    function showResultModal() {
        const modal = document.getElementById('resultModal');
        const content = document.getElementById('resultContent');
        
        const totalTime = currentSession.totalTime;
        const targetTime = currentSession.targetTime;
        const totalQuestions = currentSession.questions.reduce((a, b) => a + b, 0);
        const completed = currentSession.mode === 'exam' ? totalQuestions : currentSession.completedQuestions.length;
        const avgTime = (totalTime / completed).toFixed(1);
        
        const minutesUsed = Math.floor(totalTime / 60);
        const secondsUsed = totalTime % 60;
        const minutesTarget = Math.floor(targetTime / 60);
        
        let reward = 0;
let rewardReason = [];

if (totalTime <= targetTime) {
    reward += REWARD_SETTINGS.onTime;
    rewardReason.push(`Ho√†n th√†nh ƒë√∫ng th·ªùi gian: +${REWARD_SETTINGS.onTime.toLocaleString('vi-VN')}ƒë`);
}

if (totalTime <= targetTime * 0.8) {
    reward += REWARD_SETTINGS.fast;
    rewardReason.push(`L√†m nhanh h∆°n 20%: +${REWARD_SETTINGS.fast.toLocaleString('vi-VN')}ƒë`);
}

if (completed === totalQuestions) {
    reward += REWARD_SETTINGS.complete100;
    rewardReason.push(`Ho√†n th√†nh 100%: +${REWARD_SETTINGS.complete100.toLocaleString('vi-VN')}ƒë`);
} else if (completed >= totalQuestions * 0.9) {
    reward += REWARD_SETTINGS.complete90;
    rewardReason.push(`Ho√†n th√†nh 90%+: +${REWARD_SETTINGS.complete90.toLocaleString('vi-VN')}ƒë`);
}

if (currentSession.mode === 'exam') {
    reward += REWARD_SETTINGS.examBonus;
    rewardReason.push(`Ch·∫ø ƒë·ªô luy·ªán thi (bonus): +${REWARD_SETTINGS.examBonus.toLocaleString('vi-VN')}ƒë`);
}
        
        currentSession.reward = reward;
        
        let encouragement = '';
        if (completed === totalQuestions && totalTime <= targetTime) {
            encouragement = 'üåü Xu·∫•t s·∫Øc! Con ƒë√£ l√†m b√†i r·∫•t t·ªët!';
        } else if (completed >= totalQuestions * 0.8) {
            encouragement = 'üí™ T·ªët l·∫Øm! Con ƒëang ti·∫øn b·ªô!';
        } else {
            encouragement = 'üéØ Con c·ªë g·∫Øng nh√©! L·∫ßn sau s·∫Ω t·ªët h∆°n!';
        }
        
        let slowWarning = '';
        if (currentSession.mode !== 'exam' && avgTime > 3) {
            slowWarning = `<div class="encouragement" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                ‚ö†Ô∏è Con l√†m trung b√¨nh m·ªói c√¢u m·∫•t ${avgTime} ph√∫t. 
                ${currentSession.callParentLogs.length === 0 ? 'Con ƒë√£ th·ª≠ d√πng Chat AI ch∆∞a nh·ªâ?' : ''}
                H√£y t·∫≠p trung h∆°n v√† s·ª≠ d·ª•ng c√¥ng c·ª• h·ªó tr·ª£ khi c·∫ßn nh√©!
            </div>`;
        }
        
        content.innerHTML = `
            <div class="stats-summary">
                <div class="stat-row">
                    <span><strong>Ch·∫ø ƒë·ªô:</strong></span>
                    <span>${currentSession.mode === 'exam' ? 'üéØ Luy·ªán thi' : 'üìù L√†m b√†i th∆∞·ªùng'}</span>
                </div>
                <div class="stat-row">
                    <span><strong>Th·ªùi gian l√†m b√†i:</strong></span>
                    <span>${minutesUsed} ph√∫t ${secondsUsed} gi√¢y</span>
                </div>
                <div class="stat-row">
                    <span><strong>M·ª•c ti√™u:</strong></span>
                    <span>${minutesTarget} ph√∫t</span>
                </div>
                <div class="stat-row">
                    <span><strong>Ho√†n th√†nh:</strong></span>
                    <span>${completed}/${totalQuestions} c√¢u (${currentSession.completionRate}%)</span>
                </div>
                <div class="stat-row">
                    <span><strong>Trung b√¨nh m·ªói c√¢u:</strong></span>
                    <span>${avgTime} ph√∫t</span>
                </div>
                ${currentSession.mode !== 'exam' ? `<div class="stat-row">
                    <span><strong>S·ªë l·∫ßn g·ªçi b·ªë m·∫π:</strong></span>
                    <span>${currentSession.callParentLogs.length} l·∫ßn</span>
                </div>` : ''}
            </div>
            
            <div class="encouragement">${encouragement}</div>
            ${slowWarning}
            
            <div class="reward-display">
                üí∞ Ti·ªÅn th∆∞·ªüng: ${reward.toLocaleString('vi-VN')}ƒë
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin: 15px 0;">
                <strong>Chi ti·∫øt th∆∞·ªüng:</strong>
                ${rewardReason.map(r => `<div style="margin: 5px 0;">‚úì ${r}</div>`).join('')}
            </div>
            
            ${currentSession.subject.requireSubmit ? `
            <div class="submit-guide">
                <h3>üìã H∆∞·ªõng d·∫´n n·ªôp b√†i (5 ph√∫t):</h3>
                <ol>
                    <li><strong>B∆∞·ªõc 1:</strong> Ch·ª•p/Scan t·∫•t c·∫£ c√°c trang b√†i l√†m b·∫±ng ƒëi·ªán tho·∫°i</li>
                    <li><strong>B∆∞·ªõc 2:</strong> T·∫°o file PDF (d√πng CamScanner ho·∫∑c t√≠nh nƒÉng scan c·ªßa ƒëi·ªán tho·∫°i)</li>
                    <li><strong>B∆∞·ªõc 3:</strong> G·ª≠i file PDF l√™n Zalo (g·ª≠i cho ch√≠nh m√¨nh ho·∫∑c nh√≥m)</li>
                    <li><strong>B∆∞·ªõc 4:</strong> M·ªü Zalo tr√™n m√°y t√≠nh ‚Üí T·∫£i file PDF xu·ªëng</li>
                    <li><strong>B∆∞·ªõc 5:</strong> B·∫•m n√∫t "üì§ N·ªôp b√†i" ‚Üí Ch·ªçn file PDF v·ª´a t·∫£i</li>
                </ol>
                <div class="submit-warning timer-warning">
                    ‚è∞ Con c√≥ 5 ph√∫t ƒë·ªÉ ho√†n th√†nh! H√£y nhanh tay nh√©!
                </div>
            </div>
            <button class="btn btn-success" onclick="submitWork()">üì§ N·ªôp b√†i ƒë·ªÉ ch·∫•m</button>
            ` : '<p style="text-align: center; color: #666; margin: 20px 0;">B√†i n√†y kh√¥ng c·∫ßn n·ªôp</p>'}
            <button class="btn btn-secondary" onclick="skipSubmit()">B·ªè qua</button>
        `;
        
        modal.classList.add('active');
    }

    async function submitWork() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/pdf,image/*';
        input.multiple = true;
        
        input.onchange = async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) {
                alert('‚ùå Ch∆∞a ch·ªçn file n√†o!');
                return;
            }
            
            showLoading('üì§ ƒêang upload b√†i l√†m l√™n Drive...');
            
            try {
                const uploadResults = [];
                
                for (let file of files) {
                    const fileBase64 = await fileToBase64(file);
                    
                    const uploadResponse = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'upload',
                            fileName: file.name,
                            fileBase64: fileBase64.split(',')[1],
                            subject: currentSession.subject.subject,
                            sessionDate: new Date().toISOString()
                        })
                    });
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (!uploadData.success) {
                        throw new Error(`Upload failed: ${uploadData.error}`);
                    }
                    
                    uploadResults.push({
                        fileName: file.name,
                        fileId: uploadData.fileId,
                        driveUrl: uploadData.driveUrl,
                        fileBase64: fileBase64.split(',')[1]
                    });
                }
                
                hideLoading();
                
                currentSession.submittedFiles = uploadResults;
                
                const wantGrade = confirm(
                    `‚úÖ ƒê√£ upload ${files.length} file l√™n Drive!\n\n` +
                    `üîó Xem t·∫°i: ${uploadResults[0].driveUrl}\n\n` +
                    `ü§ñ B·∫°n c√≥ mu·ªën AI ch·∫•m b√†i ngay kh√¥ng?`
                );
                
                if (wantGrade) {
                    await gradeAssignment(uploadResults[0].fileId, uploadResults[0].fileBase64);
                } else {
                    alert('üìù B√†i l√†m ƒë√£ ƒë∆∞·ª£c l∆∞u. M·∫π s·∫Ω ch·∫•m sau nh√©!');
                    skipSubmit();
                }
                
            } catch (error) {
                hideLoading();
                console.error('Upload error:', error);
                alert('‚ùå L·ªói khi upload: ' + error.message);
            }
        };
        
        input.click();
    }

    async function gradeAssignment(fileId, fileBase64) {
        showLoading('ü§ñ AI ƒëang ch·∫•m b√†i... (10-30 gi√¢y)');
        
        try {
            const totalQuestions = currentSession.questions.reduce((a, b) => a + b, 0);
            
            const gradeResponse = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'grade',
                    submissionId: fileId,
                    fileBase64: fileBase64,
                    subject: currentSession.subject.subject,
                    totalQuestions: totalQuestions
                })
            });
            
            const gradeData = await gradeResponse.json();
            
            if (!gradeData.success) {
                throw new Error(gradeData.error);
            }
            
            hideLoading();
            showGradingResult(gradeData.result);
            
        } catch (error) {
            hideLoading();
            console.error('Grading error:', error);
            alert('‚ùå L·ªói khi ch·∫•m b√†i: ' + error.message + '\n\nM·∫π s·∫Ω ch·∫•m th·ªß c√¥ng nh√©!');
            skipSubmit();
        }
    }

    function showGradingResult(result) {
        const modal = document.getElementById('resultModal');
        const content = document.getElementById('resultContent');
        
        const isMath = currentSession.subject.subject.includes('To√°n') || 
                       currentSession.subject.subject.includes('Math');
        
        let detailHTML = '';
        
        if (isMath) {
            detailHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 3em; font-weight: bold;">${result.totalScore}/${result.maxScore}</div>
                    <div style="font-size: 1.2em; margin-top: 10px;">ƒêi·ªÉm: ${result.percentage}%</div>
                </div>
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìù Chi ti·∫øt t·ª´ng c√¢u:</h3>
                    ${result.questions.map(q => `
                        <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid ${q.answerCorrect ? '#4caf50' : '#ff5252'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <strong>C√¢u ${q.number}</strong>
                                <span style="background: ${q.answerCorrect ? '#4caf50' : '#ff5252'}; color: white; padding: 3px 10px; border-radius: 5px;">
                                    ${q.score}/${q.maxScore} ƒëi·ªÉm
                                </span>
                            </div>
                            <p style="color: #666; margin-top: 10px;">${q.feedback}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            detailHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 2.5em; font-weight: bold;">${result.cefrLevel}</div>
                    <div style="font-size: 1.2em; margin-top: 10px;">${result.totalScore}/${result.maxScore} ƒëi·ªÉm</div>
                    <div style="font-size: 1em; margin-top: 5px; opacity: 0.9;">Target: ${result.targetLevel}</div>
                </div>
                
                <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Ti√™u ch√≠ ch·∫•m:</h3>
                    ${Object.entries(result.criteria).map(([key, value]) => `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="text-transform: capitalize;">${key}</span>
                                <strong>${value}/5</strong>
                            </div>
                            <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                                <div style="background: #667eea; height: 100%; width: ${value * 20}%;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${result.specificFeedback && result.specificFeedback.length > 0 ? `
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #856404; margin-bottom: 15px;">‚úèÔ∏è L·ªói c·∫ßn s·ª≠a:</h3>
                    ${result.specificFeedback.map(fb => `
                        <div style="padding: 10px; background: white; border-radius: 5px; margin-bottom: 10px;">
                            ${fb}
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;
        }
        
        detailHTML += `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #2e7d32; margin-bottom: 10px;">üí™ ƒêi·ªÉm m·∫°nh:</h3>
                    <ul style="margin-left: 20px;">
                        ${result.strengths.map(s => `<li style="margin: 5px 0;">${s}</li>`).join('')}
                    </ul>
                </div>
                <div style="background: #fff3e0; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #e65100; margin-bottom: 10px;">üìà C·∫ßn c·∫£i thi·ªán:</h3>
                    <ul style="margin-left: 20px;">
                        ${result.improvements.map(i => `<li style="margin: 5px 0;">${i}</li>`).join('')}
                    </ul>
                </div>
            </div>
            
            <div class="encouragement" style="margin-bottom: 20px;">
                ${result.overall}
            </div>
            
            <button class="btn btn-success" onclick="closeResultModalAndContinue()" style="width: 100%;">Ti·∫øp t·ª•c h·ªçc</button>
        `;
        
        content.innerHTML = `
            <h2 style="color: #667eea; margin-bottom: 20px;">ü§ñ K·∫øt qu·∫£ ch·∫•m b√†i AI</h2>
            ${detailHTML}
        `;
        
        modal.classList.add('active');
    }

    function closeResultModalAndContinue() {
        closeModal('resultModal');
        skipSubmit();
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function showLoading(message) {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                color: white;
            `;
            document.body.appendChild(overlay);
        }
        
        overlay.innerHTML = `
            <div style="font-size: 3em; margin-bottom: 20px; animation: spin 1s linear infinite;">‚è≥</div>
            <div style="font-size: 1.5em; text-align: center; padding: 0 20px;">${message}</div>
        `;
        overlay.style.display = 'flex';
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = 'none';
        }
    }

    function skipSubmit() {
        completedSubjects.push(currentSession.index);
        saveProgress();
        closeModal('resultModal');
        loadSchedule();
        
        saveSessionData();
        
        const breakTime = currentSession.mode === 'exam' ? 10 : 5;
        showBreakModal(breakTime);
    }

    function closeResultModal() {
        closeModal('resultModal');
        completedSubjects.push(currentSession.index);
        saveProgress();
        loadSchedule();
        showBreakModal();
    }

    function showBreakModal(breakMinutes = 5) {
        const modal = document.getElementById('breakModal');
        const title = modal.querySelector('h2');
        title.textContent = `‚òï Ngh·ªâ gi·∫£i lao (${breakMinutes} ph√∫t)`;
        modal.classList.add('active');
 renderBreakActivities(); 
        startBreakTimer(breakMinutes * 60);
    }

    function startBreakTimer(seconds) {
        let timeLeft = seconds;
        const display = document.getElementById('breakTimer');
        display.textContent = `${String(Math.floor(timeLeft / 60)).padStart(2, '0')}:${String(timeLeft % 60).padStart(2, '0')}`;
        
        breakTimerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
display.textContent = `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        if (timeLeft <= 0) {
            clearInterval(breakTimerInterval);
            playAlarm();
            alert('‚è∞ H·∫øt gi·ªù ngh·ªâ r·ªìi! Chu·∫©n b·ªã h·ªçc ti·∫øp nh√©! üí™');
            skipBreak();
        }
    }, 1000);
    
    breakWarningTimeout = setTimeout(() => {
        logActivity('‚ö†Ô∏è C·∫¢NH B√ÅO', 'ƒê√£ qu√° 7 ph√∫t ngh·ªâ gi·∫£i lao, ch∆∞a th·∫•y con ho·∫°t ƒë·ªông');
    }, 420000);
}

function playAlarm() {
    const audio = document.getElementById('alarmSound');
    audio.play().catch(e => console.log('Cannot play alarm:', e));
}

function selectActivity(activity) {
    logActivity('Ho·∫°t ƒë·ªông gi·∫£i lao', activity);
    alert(`Tuy·ªát! H√£y ${activity.toLowerCase()} nh√©! üòä`);
}

function skipBreak() {
    clearInterval(breakTimerInterval);
    clearTimeout(breakWarningTimeout);
    closeModal('breakModal');
    currentSession = null;
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('active');
    modal.style.display = 'none';
    
    // ‚úÖ TH√äM ƒêO·∫†N N√ÄY: Reset currentSession khi ƒë√≥ng modal setup/work
    if (modalId === 'setupModal' || modalId === 'workModal') {
        // Clear timer n·∫øu c√≥
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        
        // Reset session
        if (currentSession && !completedSubjects.includes(currentSession.index)) {
            // Ch·ªâ reset n·∫øu ch∆∞a ho√†n th√†nh
            currentSession = null;
        }
        
        // Reload l·∫°i schedule ƒë·ªÉ b·ªè tr·∫°ng th√°i "in-progress"
        loadSchedule();
    }
}

function showAlert(message, duration = 5000) {
    const banner = document.getElementById('alertBanner');
    const messageEl = document.getElementById('alertMessage');
    messageEl.textContent = message;
    banner.classList.add('active');
    
    setTimeout(() => {
        banner.classList.remove('active');
    }, duration);
}

function saveProgress() {
    localStorage.setItem('completedSubjects', JSON.stringify(completedSubjects));
}

function loadProgress() {
    const saved = localStorage.getItem('completedSubjects');
    if (saved) {
        completedSubjects = JSON.parse(saved);
    }
    
    const lastReset = localStorage.getItem('lastReset');
    const today = new Date().toDateString();
    if (lastReset !== today) {
        completedSubjects = [];
        localStorage.setItem('lastReset', today);
        localStorage.setItem('completedSubjects', JSON.stringify([]));
    }
}

async function saveSessionData() {
    let aiChatCount = 0;
    const logs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
    logs.forEach(log => {
        if (log.type === 'M·ªü chat AI' && log.detail.includes(currentSession.subject.subject)) {
            aiChatCount++;
        }
    });

    const totalQuestions = currentSession.questions.reduce((a, b) => a + b, 0);
    const questionsList = [];
    for (let i = 0; i < totalQuestions; i++) {
        questionsList.push({
            completed: currentSession.mode === 'exam' ? true : currentSession.completedQuestions.includes(i),
            timeSpent: currentSession.mode === 'exam' ? Math.floor(currentSession.totalTime / totalQuestions) : null
        });
    }

    let feedback = '';

// 1. HO√ÄN H·∫¢O (100% + ƒë√∫ng gi·ªù ho·∫∑c nhanh h∆°n)
if (currentSession.completionRate >= 100 && currentSession.totalTime <= currentSession.targetTime) {
    const messages = [
        'üåü XU·∫§T S·∫ÆC! Con ƒë√£ l√†m xong ƒë√∫ng gi·ªù v√† ƒë·∫ßy ƒë·ªß! ƒê√¢y ch√≠nh l√† c√°ch m√† nh·ªØng ng∆∞·ªùi th√†nh c√¥ng nh·∫•t th·∫ø gi·ªõi b·∫Øt ƒë·∫ßu ng√†y m·ªõi c·ªßa h·ªç!\n‚ÄúTh√†nh c√¥ng l√† t·ªïng h·ª£p c·ªßa nh·ªØng n·ªó l·ª±c nh·ªè, l·∫∑p ƒëi l·∫∑p l·∫°i m·ªói ng√†y.‚Äù ‚Äì Robert Collier',

        'üî• CON TRAI/CON G√ÅI B·ªê M·∫∏ L√Ä S·ªê 1! Ho√†n th√†nh 100% v√† c√≤n nhanh h∆°n m·ª•c ti√™u n·ªØa ch·ª©!\n‚ÄúThe secret of getting ahead is getting started‚Ä¶ and finishing strong.‚Äù ‚Äì Mark Twain (ƒë√£ ƒë∆∞·ª£c con l√†m xu·∫•t s·∫Øc c·∫£ hai!)',

        'üèÜ H√¥m nay con ƒë√£ ƒë√°nh b·∫°i ch√≠nh m√¨nh c·ªßa ng√†y h√¥m qua. ƒê√¢y ch√≠nh l√† c√¥ng th·ª©c c·ªßa m·ªçi nh√† v√¥ ƒë·ªãch!\n‚ÄúNg∆∞·ªùi chi·∫øn th·∫Øng kh√¥ng bao gi·ªù b·ªè cu·ªôc, ng∆∞·ªùi b·ªè cu·ªôc kh√¥ng bao gi·ªù chi·∫øn th·∫Øng.‚Äù ‚Äì Vince Lombardi',

        '‚ú® Con ∆°i, ƒë√¢y kh√¥ng ph·∫£i l√† m·ªôt bu·ªïi h·ªçc b√¨nh th∆∞·ªùng. ƒê√¢y l√† m·ªôt ng√†y con ch·ª©ng minh m√¨nh sinh ra ƒë·ªÉ vƒ© ƒë·∫°i!\n‚ÄúThe future belongs to those who believe in the beauty of their dreams.‚Äù ‚Äì Eleanor Roosevelt',

        '‚ö° Con v·ª´a l·∫≠p m·ªôt k·ª∑ l·ª•c m√† ch·ªâ nh·ªØng ng∆∞·ªùi c√≥ k·ª∑ lu·∫≠t th√©p m·ªõi l√†m ƒë∆∞·ª£c!\n‚ÄúDiscipline is choosing between what you want now and what you want most.‚Äù ‚Äì Abraham Lincoln',

        'üíé Con ch√≠nh l√† vi√™n kim c∆∞∆°ng ƒëang ƒë∆∞·ª£c m√†i m·ªói ng√†y. H√¥m nay l·∫°i s√°ng l·∫•p l√°nh h∆°n h√¥m qua r·ªìi!\n‚ÄúI am not what happened to me, I am what I choose to become.‚Äù ‚Äì Carl Jung',

        'üåà Con v·ª´a v·∫Ω th√™m m·ªôt ng√†y HO√ÄN H·∫¢O v√†o cu·ªën s√°ch cu·ªôc ƒë·ªùi m√¨nh. B·ªë m·∫π ƒëang ƒë·ªçc m√† n·ªïi da g√† ƒë√¢y!\n‚ÄúGreat things never came from comfort zones.‚Äù ‚Äì Roy Bennett',

        'üëë H√¥m nay con kh√¥ng ch·ªâ ho√†n th√†nh ‚Äì con ƒë√£ TH·ªêNG TR·ªä m·ª•c ti√™u!\n‚ÄúToday‚Äôs accomplishments were yesterday‚Äôs impossibilities.‚Äù ‚Äì Robert H. Schuller',

        '‚ù§Ô∏è B·ªë m·∫π kh√¥ng n√≥i su√¥ng ƒë√¢u: Con ƒëang ƒëi ƒë√∫ng con ƒë∆∞·ªùng m√† Elon Musk, Messi, S∆°n T√πng‚Ä¶ t·ª´ng ƒëi ƒë·∫•y!\nKeep showing up like this, and the world will make room for you.'
    ];
    feedback = messages[Math.floor(Math.random() * messages.length)];

// 2. R·∫§T T·ªêT (‚â• 90%)
} else if (currentSession.completionRate >= 90) {
    const messages = [
        'üí™ R·∫§T XU·∫§T S·∫ÆC! Ch·ªâ c√≤n m·ªôt b∆∞·ªõc ch√¢n n·ªØa th√¥i l√† con ch·∫°m ƒë·∫øn s·ª± ho√†n h·∫£o r·ªìi!\n‚ÄúCon kh√¥ng c·∫ßn ph·∫£i gi·ªèi ƒë·ªÉ b·∫Øt ƒë·∫ßu, nh∆∞ng con ph·∫£i b·∫Øt ƒë·∫ßu ƒë·ªÉ tr·ªü n√™n gi·ªèi.‚Äù ‚Äì Zig Ziglar',

        'üöÄ Con ƒëang ·ªü ƒë√∫ng qu·ªπ ƒë·∫°o c·ªßa nh·ªØng ng∆∞·ªùi s·∫Ω l√†m n√™n chuy·ªán l·ªõn!\n‚ÄúI‚Äôve failed over and over and over again in my life. And that is why I succeed.‚Äù ‚Äì Michael Jordan',

        '‚ú® 90%+ l√† m·ª©c m√† 99% ng∆∞·ªùi kh√°c ch·ªâ d√°m m∆°. Con th√¨ ƒëang s·ªëng trong ƒë√≥ m·ªói ng√†y!\n‚ÄúTh√†nh c√¥ng kh√¥ng ph·∫£i l√† ƒë√≠ch ƒë·∫øn, m√† l√† h√†nh tr√¨nh.‚Äù ‚Äì Zig Ziglar',

        'üî• Con trai/con g√°i ∆°i, b·ªë m·∫π nh√¨n th·∫•y t∆∞∆°ng lai c·ª±c k·ª≥ s√°ng c·ªßa con r·ªìi ƒë·∫•y!\n‚ÄúFall seven times, stand up eight.‚Äù ‚Äì Nh·∫≠t B·∫£n',

        'üåü Ch·ªâ thi·∫øu ch√∫t x√≠u n·ªØa th√¥i l√† con l·∫≠p k·ª∑ l·ª•c m·ªõi. C·∫£m gi√°c n√†y tuy·ªát ch·ª© con?\n‚ÄúThe only way to do great work is to love what you do.‚Äù ‚Äì Steve Jobs',

        'üèÖ H√¥m nay con l·∫°i ch·ª©ng minh: Khi con nghi√™m t√∫c, kh√¥ng g√¨ c·∫£n n·ªïi!\n‚ÄúDon‚Äôt watch the clock; do what it does. Keep going.‚Äù ‚Äì Sam Levenson',

        'üíô C·ª© gi·ªØ l·ª≠a n√†y, 5‚Äì10 nƒÉm n·ªØa con s·∫Ω c·∫£m ∆°n ch√≠nh m√¨nh c·ªßa h√¥m nay!\n‚ÄúThe best investment you can make is in yourself.‚Äù ‚Äì Warren Buffett',

        '‚ö° Con ƒëang ti·∫øn b·ªô v·ªõi t·ªëc ƒë·ªô m√† ng∆∞·ªùi kh√°c ph·∫£i ng∆∞·ªõc nh√¨n. T·ª± h√†o l·∫Øm!'
    ];
    feedback = messages[Math.floor(Math.random() * messages.length)];

// 3. CH·∫¨M NHI·ªÄU (totalTime > targetTime * 1.5)
} else if (currentSession.totalTime > currentSession.targetTime * 1.5) {
    const messages = [
        '‚è∞ H√¥m nay con h∆°i ch·∫≠m h∆°n m·ªôt ch√∫t, kh√¥ng sao c·∫£ con trai/con g√°i ∆°i!\n‚ÄúTh·ªùi gian qu√Ω h∆°n ti·ªÅn b·∫°c. Con c√≥ th·ªÉ ki·∫øm th√™m ti·ªÅn, nh∆∞ng kh√¥ng th·ªÉ ki·∫øm th√™m th·ªùi gian.‚Äù ‚Äì Jim Rohn\nL·∫ßn sau m√¨nh c√πng t·∫≠p trung h∆°n nh√©, b·ªë m·∫π tin con l√†m ƒë∆∞·ª£c!',

        '‚ö° Con ∆°i, ai m√† ch·∫≥ng c√≥ ng√†y h∆°i ‚Äúlag‚Äù m·ªôt ch√∫t. Quan tr·ªçng l√† con ƒë√£ kh√¥ng b·ªè cu·ªôc!\n‚ÄúT√¥i kh√¥ng thua, t√¥i ch·ªâ t√¨m ra 10.000 c√°ch kh√¥ng ho·∫°t ƒë·ªông th√¥i.‚Äù ‚Äì Thomas Edison',

        '‚ù§Ô∏è Kh√¥ng sao ƒë√¢u con y√™u, ng√†y mai l√† m·ªôt ng√†y ho√†n to√†n m·ªõi!\n‚ÄúCh·ªâ nh·ªØng ng∆∞·ªùi d√°m th·∫•t b·∫°i l·ªõn m·ªõi c√≥ th·ªÉ ƒë·∫°t ƒë∆∞·ª£c th√†nh c√¥ng l·ªõn.‚Äù ‚Äì Robert F. Kennedy',

        'üå± C√¢y mu·ªën cao ph·∫£i ch·ªãu m∆∞a gi√≥. H√¥m nay ch·∫≠m m·ªôt ch√∫t, mai con s·∫Ω nhanh g·∫•p ƒë√¥i!\n‚ÄúIt‚Äôs not how fast you go, it‚Äôs that you don‚Äôt stop.‚Äù ‚Äì Kh·ªïng T·ª≠',

        'üí° C√≥ th·ªÉ h√¥m nay con ch∆∞a t·∫≠p trung t·ªëi ƒëa, nh∆∞ng b·ªë m·∫π bi·∫øt con c√≥ th·ªÉ l√†m ch·ªß th·ªùi gian m√†!\n‚ÄúThe best way to predict the future is to create it.‚Äù ‚Äì Peter Drucker',

        'üê¢ Nh·ªõ c√¢u chuy·ªán r√πa v√† th·ªè kh√¥ng con? R√πa th·∫Øng v√¨ ki√™n tr√¨. Con v·∫´n ƒëang v·ªÅ ƒë√≠ch, th·∫ø l√† th·∫Øng r·ªìi!\n‚ÄúSlow and steady wins the race.‚Äù',

        'ü´Ç B·ªë m·∫π ·ªü ƒë√¢y kh√¥ng ph·∫£i ƒë·ªÉ tr√°ch, m√† ƒë·ªÉ c√πng con m·∫°nh m·∫Ω h∆°n m·ªói ng√†y. Mai m√¨nh ‚Äúph·ª•c th√π‚Äù nh√© con!'
    ];
    feedback = messages[Math.floor(Math.random() * messages.length)];

// 4. C√íN L·∫†I (d∆∞·ªõi 90% ho·∫∑c h∆°i ch·∫≠m)
} else {
    const messages = [
        'üëç C·ªë l√™n con y√™u! M·ªói ng√†y con ng·ªìi v√†o b√†n h·ªçc l√† con ƒë√£ th·∫Øng s·ª± l∆∞·ªùi bi·∫øng r·ªìi!\n‚ÄúThe man who moves a mountain begins by carrying away small stones.‚Äù ‚Äì Kh·ªïng T·ª≠',

        'üå± Con ƒëang gieo nh·ªØng h·∫°t gi·ªëng th√†nh c√¥ng. C√≥ khi h√¥m nay ch∆∞a n·∫£y m·∫ßm, nh∆∞ng c√¢y ƒëang l·ªõn l√™n t·ª´ng ng√†y!\n‚ÄúIt does not matter how slowly you go as long as you do not stop.‚Äù ‚Äì Kh·ªïng T·ª≠',

        'üíô B·ªë m·∫π t·ª± h√†o v√¨ con ƒë√£ kh√¥ng b·ªè cu·ªôc. ƒê√≥ l√† ph·∫©m ch·∫•t c·ªßa m·ªçi ng∆∞·ªùi vƒ© ƒë·∫°i!\n‚ÄúYou don‚Äôt have to be great to start, but you have to start to be great.‚Äù ‚Äì Zig Ziglar',

        'üî• M·ªói l·∫ßn con c·ªë g·∫Øng l√† con ƒëang r√®n m·ªôt thanh ki·∫øm s·∫Øc b√©n h∆°n cho t∆∞∆°ng lai!\n‚ÄúEvery master was once a disaster.‚Äù ‚Äì David Goggins',

        'üåü H√¥m nay ch∆∞a ph·∫£i ng√†y ƒë·∫πp nh·∫•t c·ªßa con, nh∆∞ng ch·∫Øc ch·∫Øn l√† n·ªÅn m√≥ng cho nh·ªØng ng√†y ƒë·∫πp nh·∫•t s·∫Øp t·ªõi!\n‚ÄúThe expert in anything was once a beginner.‚Äù ‚Äì Helen Hayes',

        '‚ù§Ô∏è Con ch·ªâ c·∫ßn t·ªët h∆°n ch√≠nh m√¨nh ng√†y h√¥m qua l√† b·ªë m·∫π ƒë√£ h·∫°nh ph√∫c l·∫Øm r·ªìi!\n‚ÄúBe better than the you from yesterday.‚Äù',

        'üí™ Con ∆°i, nh·ªØng ng∆∞·ªùi th√†nh c√¥ng nh·∫•t th·∫ø gi·ªõi c≈©ng t·ª´ng c√≥ ng√†y nh∆∞ th·∫ø n√†y. ƒêi·ªÅu kh√°c bi·ªát l√† h·ªç kh√¥ng bao gi·ªù d·ª´ng l·∫°i. Con c≈©ng th·∫ø!'
    ];
    feedback = messages[Math.floor(Math.random() * messages.length)];
}

    const sessionData = {
        id: 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        date: new Date().toISOString(),
        subject: currentSession.subject.subject,
        mode: currentSession.mode,
        time: currentSession.totalTime,
        targetTime: currentSession.targetTime,
        completionRate: currentSession.completionRate,
        reward: currentSession.reward,
        questions: questionsList,
        aiChatCount: aiChatCount,
        callParentCount: currentSession.callParentLogs ? currentSession.callParentLogs.length : 0,
        callParentLogs: currentSession.callParentLogs || [],
        feedback: feedback,
        score: currentSession.submittedFiles ? undefined : undefined,
        total: totalQuestions,
        paid: false,
        paidDate: null,
        submittedFiles: currentSession.submittedFiles || null
    };
    
    let history = JSON.parse(localStorage.getItem('sessionHistory') || '[]');
sessionData.id = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
history.push(sessionData);
localStorage.setItem('sessionHistory', JSON.stringify(history));

// ‚úÖ L∆ØU L√äN FIREBASE
try {
    await db.collection('sessions').add(sessionData);
    console.log('‚úÖ Session saved to Firebase:', sessionData);
    
    await db.collection('activityLogs').add({
        timestamp: new Date().toISOString(),
        type: 'Ho√†n th√†nh b√†i t·∫≠p',
        detail: `${currentSession.subject.subject} - ${currentSession.completionRate}%`
    });
} catch (error) {
    console.error('‚ùå Firebase save error:', error);
}
}

const firebaseConfig = {
    apiKey: "AIzaSyBv5qOVgNajnOKoz-vaIYENSWZY2jB8N30",
    authDomain: "honey-4d9b1.firebaseapp.com",
    projectId: "honey-4d9b1",
    storageBucket: "honey-4d9b1.firebasestorage.app",
    messagingSenderId: "108470975596",
    appId: "1:108470975596:web:c3223c55e7afbd9276ac49"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyQgklJRPBeMHRX6x0gyBjEgx_UAMqWLD-OPu39c0pLbVkr7XeFa5RdfyrzH6mhtcXKYg/exec';

function showTab(tabName, buttonElement) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    const tabContent = document.getElementById('tab-' + tabName);
    if (tabContent) {
        tabContent.style.display = 'block';
    }
    
    if (buttonElement) {
        buttonElement.classList.add('active');
    }
    
    // Load data khi chuy·ªÉn tab
    if (tabName === 'schedule') {
        document.getElementById('scheduleContainer').style.display = 'grid';
    } else {
        document.getElementById('scheduleContainer').style.display = 'none';
    }
    
    if (tabName === 'stats') loadKidStats();
    if (tabName === 'messages') loadMessages();
}

function logActivity(type, detail) {
    const log = {
        timestamp: new Date().toISOString(),
        type: type,
        detail: detail
    };
    
    let logs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
    logs.push(log);
    localStorage.setItem('activityLogs', JSON.stringify(logs));
    
    console.log('Activity logged:', log);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

let kidSessionHistory = [];

async function loadKidStats() {
    try {
        const snap = await db.collection('sessions').orderBy('date', 'desc').get();
        kidSessionHistory = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));

        const today = new Date().toDateString();
        const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);

        let todayReward = 0, weekReward = 0, totalReward = 0;
        const historyHTML = [];

        kidSessionHistory.forEach(s => {
            const reward = s.reward || 0;
            totalReward += reward;
            if (new Date(s.date).toDateString() === today) todayReward += reward;
            if (new Date(s.date) >= weekAgo) weekReward += reward;

            if (reward > 0) {
                const date = new Date(s.date).toLocaleDateString('vi-VN');
                historyHTML.push(`
                    <div style="background: white; padding: 18px; border-radius: 18px; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 6px solid #667eea;">
                        <div style="font-weight: bold; font-size: 1.3em; color: #333;">${s.subject} ‚Ä¢ ${date}</div>
                        <div style="margin-top: 8px; font-size: 1.4em; color: #4caf50; font-weight: bold;">+${reward.toLocaleString()}ƒë</div>
                        ${s.feedback ? `<div style="margin-top: 8px; color: #666; font-style: italic;">"${s.feedback}"</div>` : ''}
                    </div>
                `);
            }
        });

        document.getElementById('kidTodayReward').textContent = todayReward.toLocaleString() + 'ƒë';
        document.getElementById('kidWeekReward').textContent = weekReward.toLocaleString() + 'ƒë';
        document.getElementById('kidTotalReward').textContent = totalReward.toLocaleString() + 'ƒë';
        document.getElementById('kidRewardHistory').innerHTML = historyHTML.join('') || '<p>Ch∆∞a c√≥ l·ªãch s·ª≠ th∆∞·ªüng n√†o</p>';

        const todayKey = new Date().toISOString().split('T')[0];
        const refDoc = await db.collection('reflections').doc(todayKey).get();
        if (refDoc.exists) {
            document.getElementById('reflectionText').value = refDoc.data().text;
            document.getElementById('reflectionStatus').textContent = 'ƒê√£ g·ª≠i l√∫c ' + new Date(refDoc.data().timestamp).toLocaleTimeString('vi-VN');
        }
    } catch (e) { console.error(e); }
}

async function saveReflection() {
    const text = document.getElementById('reflectionText').value.trim();
    if (!text) return alert('Vi·∫øt g√¨ ƒë√≥ ƒëi con!');
    
    const todayKey = new Date().toISOString().split('T')[0];
    await db.collection('reflections').doc(todayKey).set({
        text: text,
        timestamp: new Date().toISOString()
    });
    document.getElementById('reflectionStatus').textContent = 'ƒê√£ g·ª≠i th√†nh c√¥ng!';
}

async function loadMessages() {
    const snap = await db.collection('messages').orderBy('timestamp', 'desc').get();
    const list = document.getElementById('messagesList');
    list.innerHTML = snap.docs.map(doc => {
        const m = doc.data();
        const time = new Date(m.timestamp).toLocaleString('vi-VN', {hour: '2-digit', minute: '2-digit'});
        const isParent = m.from === 'parent';
        return `
            <div class="${isParent ? 'parent' : ''}">
                <div>
                    <small>${isParent ? 'B·ªë m·∫π' : 'Con'} ‚Ä¢ ${time}</small><br>
                    ${m.text}
                </div>
            </div>
        `;
    }).join('');
}

async function sendMessage() {
    const text = document.getElementById('messageToParent').value.trim();
    if (!text) return;
    
    await db.collection('messages').add({
        text: text,
        from: 'child',
        timestamp: new Date().toISOString()
    });
    document.getElementById('messageToParent').value = '';
    loadMessages();
}

</script>
</body>
</html>
